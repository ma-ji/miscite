{% extends "base.html" %}
{% block content %}
  {% set active_step = login_step or ("verify" if code_sent else "request") %}
  <section class="ds-section">
    <div class="ds-grid">
      <div class="span-6">
        <p class="eyebrow">Welcome</p>
        <h1>Sign in with an email code.</h1>
        <p class="lead">
          Enter your email, verify a short code, and continue where you left off.
        </p>
        <ul class="ds-list">
          <li>Resume recent jobs quickly</li>
          <li>Share read-only report links</li>
          <li>{{ record_estimate }} scholarly records indexed</li>
        </ul>
      </div>
      <div class="span-6">
        <div class="ds-card ds-card--hero">
          <div class="card-content">
            <h2>Get access</h2>
            <p class="form-help">
              No password needed. We’ll send a short code to confirm it’s you.
            </p>
          </div>
          <div class="card-content">
            <div class="ds-disclosure-list">
              <details class="ds-disclosure" {% if active_step == "request" %}open{% endif %}>
                <summary class="ds-disclosure-summary">
                  <i class="material-icons ds-disclosure-icon" aria-hidden="true">mail</i>
                  <span class="ds-disclosure-type">Step 1</span>
                  <span class="ds-disclosure-title">Email me a sign-in code</span>
                  <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                </summary>
                <div class="ds-disclosure-body">
                  <form
                    method="post"
                    action="/login/request"
                    class="ds-stack"
                    data-disable-on-submit
                    data-loading-text="Sending…"
                    data-turnstile-form
                  >
                    <div class="form-field">
                      <label class="form-label" for="email">Email</label>
                      <input
                        id="email"
                        name="email"
                        type="email"
                        required
                        autocomplete="email"
                        autocapitalize="none"
                        spellcheck="false"
                        value="{{ login_email }}"
                        {% if active_step == "request" %}autofocus{% endif %}
                      />
                    </div>
                    <div class="form-field">
                      <label class="form-label" for="session-length">Stay signed in for</label>
                      <select
                        id="session-length"
                        name="session_length"
                        aria-describedby="login-request-help"
                        required
                      >
                        <option value="session" {{ "selected" if session_choice == "session" else "" }}>
                          This browser session
                        </option>
                        <option value="7" {{ "selected" if session_choice == "7" else "" }}>7 days</option>
                        <option value="30" {{ "selected" if session_choice == "30" else "" }}>30 days</option>
                      </select>
                      <p class="form-help" id="login-request-help">
                        We’ll email a {{ login_code_length }}-digit code. It expires in {{ login_code_ttl_minutes }} minutes.
                      </p>
                    </div>
                    {% if turnstile_site_key %}
                      <div class="form-field">
                        <div
                          class="cf-turnstile"
                          data-sitekey="{{ turnstile_site_key }}"
                          data-theme="auto"
                          data-callback="misciteTurnstileReady"
                          data-expired-callback="misciteTurnstileExpired"
                          data-error-callback="misciteTurnstileError"
                        ></div>
                      </div>
                    {% endif %}
                    <button
                      class="ds-button ds-button--primary"
                      type="submit"
                      data-turnstile-submit
                      {{ "disabled" if turnstile_site_key else "" }}
                    >
                      Email code
                    </button>
                  </form>
                </div>
              </details>

              <details class="ds-disclosure" {% if active_step == "verify" %}open{% endif %}>
                <summary class="ds-disclosure-summary">
                  <i class="material-icons ds-disclosure-icon" aria-hidden="true">verified_user</i>
                  <span class="ds-disclosure-type">Step 2</span>
                  <span class="ds-disclosure-title">Enter your code</span>
                  <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                </summary>
                <div class="ds-disclosure-body">
                  <form
                    method="post"
                    action="/login/verify"
                    class="ds-stack"
                    data-disable-on-submit
                    data-loading-text="Signing in…"
                  >
                    <input type="hidden" name="email" value="{{ login_email }}" />
                    <input type="hidden" name="session_length" value="{{ session_choice }}" />

                    {% if login_email %}
                      <p class="form-help">
                        Signing in as <span class="miscite-mono">{{ login_email }}</span>.
                      </p>
                    {% else %}
                      <p class="form-help">
                        Enter your email in Step 1 first.
                      </p>
                    {% endif %}
                    <div class="form-field">
                      <label class="form-label" for="code">Sign-in code</label>
                      <input
                        id="code"
                        name="code"
                        type="text"
                        inputmode="numeric"
                        autocomplete="one-time-code"
                        maxlength="{{ login_code_length }}"
                        minlength="{{ login_code_length }}"
                        pattern="[0-9]{{ '{' }}{{ login_code_length }}{{ '}' }}"
                        required
                        aria-describedby="login-verify-help"
                        {% if active_step == "verify" %}autofocus{% endif %}
                      />
                      <p class="form-help" id="login-verify-help">
                        Enter the {{ login_code_length }} digits from your email. If needed, reopen Step 1 to resend.
                      </p>
                    </div>
                    <button class="ds-button ds-button--secondary" type="submit">Sign in</button>
                  </form>
                </div>
              </details>
            </div>
          </div>
          <div class="card-action">
            <span class="miscite-muted">Secure, passwordless access with short-lived codes.</span>
            <span class="miscite-muted">We only email sign-in tokens.</span>
          </div>
        </div>
      </div>
    </div>
  </section>
  {% if turnstile_site_key %}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  {% endif %}
  <script nonce="{{ csp_nonce }}">
    document.addEventListener("DOMContentLoaded", function () {
      var gateTurnstileButtons = function (enabled) {
        document.querySelectorAll("[data-turnstile-form]").forEach(function (form) {
          var button = form.querySelector("[data-turnstile-submit]");
          if (!button) return;
          button.disabled = !enabled;
          button.setAttribute("aria-disabled", enabled ? "false" : "true");
        });
      };

      var initTurnstileGate = function () {
        document.querySelectorAll("[data-turnstile-form]").forEach(function (form) {
          var widget = form.querySelector(".cf-turnstile");
          var button = form.querySelector("[data-turnstile-submit]");
          if (!widget || !button) return;
          button.disabled = true;
          button.setAttribute("aria-disabled", "true");
        });
      };

      initTurnstileGate();

      window.misciteTurnstileReady = function () {
        gateTurnstileButtons(true);
      };
      window.misciteTurnstileExpired = function () {
        gateTurnstileButtons(false);
      };
      window.misciteTurnstileError = function () {
        gateTurnstileButtons(false);
      };

      document.querySelectorAll("[data-disable-on-submit]").forEach(function (form) {
        form.addEventListener("submit", function () {
          var button = form.querySelector("button[type='submit']");
          if (!button) return;
          button.disabled = true;
          var loadingText = form.getAttribute("data-loading-text");
          if (loadingText) {
            button.textContent = loadingText;
          }
        });
      });
    });
  </script>
{% endblock %}
