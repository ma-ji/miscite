{% extends "base.html" %}
{% block content %}
  {% set upload_state = "idle" %}
  {% if latest_job %}
    {% if latest_job.status == "COMPLETED" %}
      {% set upload_state = "completed" %}
    {% elif latest_job.status in ["FAILED", "CANCELED"] %}
      {% set upload_state = "failed" %}
    {% elif latest_job.status in ["PENDING", "RUNNING"] %}
      {% set upload_state = "processing" %}
    {% endif %}
  {% endif %}

  <section class="ds-section ds-section--hero">
    <div class="ds-grid">
      <div class="span-8">
          <div class="ds-stack ds-stack--lg">
          <div>
            <p class="eyebrow">Workspace</p>
            <h1>Run citation checks</h1>
            <p class="lead">
              Upload a manuscript, review citation risks, and export a traceable report.
            </p>
            <p class="miscite-muted">Reports are workspace-scoped and built for editorial review.</p>
          </div>
          <div class="ds-card ds-card--hero" id="upload-module">
            <div class="card-content">
              <div class="ds-card-header ds-card-header--split">
                <div>
                  <h3>Upload manuscript</h3>
                  <p class="miscite-muted">PDF and DOCX are supported.</p>
                </div>
                {% if jobs|length == 0 and sample_report_url %}
                  <a class="ds-link" href="{{ sample_report_url }}">Sample report</a>
                {% endif %}
              </div>
              <form
                method="post"
                action="/upload"
                enctype="multipart/form-data"
                class="ds-stack ds-stack--tight"
                data-upload-form
                data-billing-disabled="{{ 'true' if (billing_required and not billing_ready) else 'false' }}"
                data-maintenance-disabled="{{ 'true' if maintenance_mode else 'false' }}"
                data-max-upload-mb="{{ max_upload_mb }}"
              >
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <div class="form-field">
                  <label class="form-label" for="file">Manuscript file</label>
                  <div
                    class="ds-dropzone {{ 'is-disabled' if (billing_required and not billing_ready) or maintenance_mode else '' }}"
                    data-dropzone
                    aria-disabled="{{ 'true' if (billing_required and not billing_ready) or maintenance_mode else 'false' }}"
                  >
                    <input
                      id="file"
                      class="ds-dropzone-input"
                      type="file"
                      name="file"
                      accept=".pdf,.docx"
                      required
                      aria-describedby="upload-constraints upload-selected"
                      {{ "disabled" if (billing_required and not billing_ready) or maintenance_mode else "" }}
                    />
                    <div class="ds-dropzone-body">
                      <span class="ds-dropzone-title">
                        Drop a PDF/DOCX here, or <span class="ds-dropzone-browse">Browse</span>
                      </span>
                      <span class="ds-dropzone-meta" id="upload-constraints">
                        PDF or DOCX · Max {{ max_upload_mb }} MB · Optional page limit
                      </span>
                    </div>
                    <div class="ds-dropzone-file" id="upload-selected" data-dropzone-file>
                      No file selected
                    </div>
                  </div>
                </div>
                <p class="form-help ds-upload-error" data-upload-error hidden></p>
                <div class="ds-upload-state" data-upload-state="{{ upload_state }}" aria-live="polite">
                  <div class="ds-upload-state-item" data-state="idle">
                    <i class="material-icons" aria-hidden="true">upload_file</i>
                    <span>Select a file to begin.</span>
                  </div>
                  <div class="ds-upload-state-item" data-state="selected">
                    <i class="material-icons" aria-hidden="true">task_alt</i>
                    <span>Ready to run. Confirm the file and start.</span>
                  </div>
                  <div class="ds-upload-state-item" data-state="uploading">
                    <div class="ds-upload-progress">
                      <div class="ds-progress-bar ds-progress-bar--inline" aria-hidden="true">
                        <div class="ds-progress-fill ds-progress-fill--indeterminate"></div>
                      </div>
                      <span>Uploading manuscript…</span>
                    </div>
                  </div>
                  <div class="ds-upload-state-item" data-state="processing">
                    <div class="ds-upload-progress">
                      <span>Processing {{ latest_job.filename if latest_job else "your manuscript" }}</span>
                      <a class="ds-link" href="{{ '/jobs/' ~ latest_job.id if latest_job else '#' }}">View status</a>
                    </div>
                    <ol class="ds-stepper" aria-label="Processing steps">
                      <li class="ds-stepper-step is-complete">
                        <span class="ds-stepper-bullet"></span>
                        <span class="ds-stepper-label">Upload</span>
                      </li>
                      <li class="ds-stepper-step is-active">
                        <span class="ds-stepper-bullet"></span>
                        <span class="ds-stepper-label">Analyze</span>
                      </li>
                      <li class="ds-stepper-step">
                        <span class="ds-stepper-bullet"></span>
                        <span class="ds-stepper-label">Report ready</span>
                      </li>
                    </ol>
                  </div>
                  <div class="ds-upload-state-item" data-state="completed">
                    <i class="material-icons" aria-hidden="true">check_circle</i>
                    <span>
                      Report ready for {{ latest_job.filename if latest_job else "your manuscript" }}.
                      <a class="ds-link" href="{{ '/jobs/' ~ latest_job.id if latest_job else '#' }}">View report</a>
                    </span>
                  </div>
                  <div class="ds-upload-state-item" data-state="failed">
                    <i class="material-icons" aria-hidden="true">error</i>
                    {% if latest_job and latest_job.status == "CANCELED" %}
                      <span>Analysis canceled. Upload again when you're ready.</span>
                    {% else %}
                      <span>
                        Analysis failed{{ ": " ~ latest_job.error_message if latest_job and latest_job.error_message else "" }}.
                        Review the error, then retry with a fresh upload.
                      </span>
                    {% endif %}
                    <button class="ds-button ds-button--ghost ds-button--sm" type="button" data-retry-upload>
                      Retry upload
                    </button>
                  </div>
                </div>
                <div class="ds-upload-actions">
                  <button
                    class="ds-button ds-button--primary"
                    type="submit"
                    data-upload-submit
                    disabled
                    {{ "disabled" if (billing_required and not billing_ready) or maintenance_mode else "" }}
                  >
                    Run check
                  </button>
                  {% if jobs|length == 0 and sample_report_url %}
                    <a class="ds-button ds-button--ghost" href="{{ sample_report_url }}">Sample report</a>
                  {% endif %}
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <div class="span-4">
        <div class="ds-panel ds-panel--compact">
          <div class="ds-panel-header">
            <div>
              <p class="eyebrow">Account</p>
              <h3>Workspace overview</h3>
            </div>
            <span class="ds-badge ds-badge--neutral">{{ balance_display }}</span>
          </div>
          <div class="ds-panel-body">
            <div class="ds-stat-grid ds-stat-grid--compact ds-stat-grid--workspace">
              <div class="ds-stat">
                <div class="ds-stat-value">{{ total_jobs }}</div>
                <div class="ds-stat-label">Total jobs</div>
              </div>
              <div class="ds-stat">
                <div class="ds-stat-value">{{ processing_count }}</div>
                <div class="ds-stat-label">Processing</div>
              </div>
              <div class="ds-stat">
                <div class="ds-stat-value">{{ failed_count }}</div>
                <div class="ds-stat-label">Needs attention</div>
              </div>
              <div class="ds-stat">
                <div class="ds-stat-value ds-stat-value--label">
                  {{ latest_job.created_at_relative if latest_job else "—" }}
                </div>
                <div class="ds-stat-label">Last run</div>
              </div>
            </div>
            <div class="ds-panel-meta">
              <span class="ds-badge">Signed in</span>
              <span class="miscite-mono">{{ current_user.email }}</span>
            </div>
          </div>
          <div class="ds-panel-actions">
            <a class="ds-button ds-button--secondary ds-button--sm" href="/billing">Manage billing</a>
            <a class="ds-icon-button" href="/dashboard" aria-label="Refresh dashboard">
              <i class="material-icons" aria-hidden="true">refresh</i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  {% if billing_required and not billing_ready %}
    <section class="ds-section ds-section--banner">
      <div class="ds-banner ds-banner--warning" role="status">
        <div>
          <p class="eyebrow">Billing</p>
          <h3>Billing setup required</h3>
          <p class="miscite-muted">
            Top up your balance (pay as you go). Optionally add a payment method and enable auto-charge to keep citation analyses running.
          </p>
        </div>
        <a class="ds-button ds-button--primary" href="/billing">Manage billing</a>
      </div>
    </section>
  {% endif %}

  <section class="ds-section ds-section--workspace">
    <div class="section-header section-header--workspace">
      <p class="eyebrow">Workspace</p>
      <h2>Recent analyses</h2>
      <p class="lead">Search, filter, and revisit your latest jobs.</p>
    </div>
    <form class="ds-table-controls ds-table-controls--workspace" method="get" action="/dashboard" data-auto-submit>
      <div class="ds-input-with-icon">
        <i class="material-icons" aria-hidden="true">search</i>
        <input
          type="search"
          name="q"
          placeholder="Search by filename (press /)"
          value="{{ query }}"
          aria-label="Search by filename"
          data-search-input
        />
      </div>
      <div class="ds-filter-cluster">
        <p class="ds-filter-label">Status</p>
        <div class="ds-filter-group" role="radiogroup" aria-label="Filter jobs by status">
          <label class="ds-filter-pill">
            <input type="radio" name="status" value="all" {{ "checked" if status_filter == "all" else "" }} />
            <span>All <span class="ds-filter-count">{{ total_jobs }}</span></span>
          </label>
          <label class="ds-filter-pill">
            <input
              type="radio"
              name="status"
              value="completed"
              {{ "checked" if status_filter == "completed" else "" }}
            />
            <span>Completed <span class="ds-filter-count">{{ completed_count }}</span></span>
          </label>
          <label class="ds-filter-pill">
            <input type="radio" name="status" value="failed" {{ "checked" if status_filter == "failed" else "" }} />
            <span>Failed <span class="ds-filter-count">{{ failed_count }}</span></span>
          </label>
          <label class="ds-filter-pill">
            <input
              type="radio"
              name="status"
              value="processing"
              {{ "checked" if status_filter == "processing" else "" }}
            />
            <span>Processing <span class="ds-filter-count">{{ processing_count }}</span></span>
          </label>
        </div>
      </div>
      <div class="form-field ds-table-control ds-table-control--sort">
        <label class="form-label" for="sort">Sort</label>
        <select id="sort" name="sort">
          <option value="newest" {{ "selected" if sort_choice == "newest" else "" }}>Newest</option>
          <option value="oldest" {{ "selected" if sort_choice == "oldest" else "" }}>Oldest</option>
          <option value="status" {{ "selected" if sort_choice == "status" else "" }}>Status</option>
        </select>
      </div>
    </form>
    <div data-workspace-results>
      <div class="ds-results-meta" role="status" aria-live="polite">
        <p>
          Showing <strong>{{ jobs|length }}</strong> of <strong>{{ matching_count }}</strong> matching
          {{ "job" if matching_count == 1 else "jobs" }}.
          {% if matching_count > display_limit %}
            Refine filters to narrow results.
          {% endif %}
        </p>
      </div>
      {% if jobs|length == 0 %}
        <div class="ds-empty">
          {% if query or status_filter != "all" %}
            <h4>No matching jobs</h4>
            <p class="miscite-muted">Try a different filename or reset your filters.</p>
          {% else %}
            <h4>No jobs yet</h4>
            <p class="miscite-muted">Upload a manuscript to generate your first report.</p>
            <a class="ds-button ds-button--secondary" href="#upload-module">Start an upload</a>
          {% endif %}
        </div>
      {% else %}
        <form
          id="bulk-job-form"
          class="ds-bulk-actions ds-bulk-actions--workspace"
          method="post"
          action="/dashboard/bulk-action"
          data-selection-state="idle"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          <div class="ds-bulk-select">
            <label class="ds-bulk-select-label">
              <input type="checkbox" data-bulk-select-all />
              <span>Select visible</span>
            </label>
            <span class="miscite-muted ds-bulk-count" data-bulk-count>0 selected</span>
          </div>
          <div class="ds-bulk-buttons">
            <label class="sr-only" for="bulk-action-select">Select bulk action</label>
            <select id="bulk-action-select" class="ds-bulk-action-select" name="bulk_action" data-bulk-action-select>
              <option value="">Bulk action</option>
              <option value="stop">Stop job</option>
              <option value="delete">Delete report</option>
            </select>
            <button class="ds-button ds-button--secondary ds-button--sm ds-bulk-apply" type="submit" data-bulk-apply disabled>
              Apply
            </button>
          </div>
        </form>
        <div class="ds-card ds-card--plain ds-card--jobs">
          <div class="card-content">
            <div class="ds-table-wrap" role="region" aria-label="Recent jobs table" tabindex="0">
              <table class="ds-table ds-table--wide ds-table--mobile ds-table--jobs">
                <caption class="sr-only">Recent analysis jobs and actions</caption>
                <thead>
                  <tr>
                    <th scope="col" class="ds-table-select-col">
                      <span class="sr-only">Select</span>
                    </th>
                    <th scope="col">Created</th>
                    <th scope="col">File</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="ds-table-actions-col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for job in jobs %}
                    <tr>
                      <td data-label="Select" class="ds-table-select-cell">
                        <label class="ds-row-check">
                          <input type="checkbox" name="job_ids" value="{{ job.id }}" form="bulk-job-form" data-job-select />
                          <span class="sr-only">Select {{ job.filename }}</span>
                        </label>
                      </td>
                      <td data-label="Created">
                        <div class="ds-job-date">
                          <time datetime="{{ job.created_at }}" title="{{ job.created_at }}">{{ job.created_at_human }}</time>
                          <span class="miscite-muted">{{ job.created_at_relative }}</span>
                        </div>
                      </td>
                      <td data-label="File">
                        <div class="ds-job-file">
                          <span title="{{ job.filename }}">{{ job.filename }}</span>
                        </div>
                      </td>
                      <td data-label="Status">
                        {% if job.status == "COMPLETED" %}
                          <span class="ds-status ds-status--success">
                            <i class="material-icons" aria-hidden="true">check_circle</i>
                            Completed
                          </span>
                        {% elif job.status == "FAILED" %}
                          <span
                            class="ds-status ds-status--error"
                            title="{{ job.error_message or 'Analysis failed. Open to view details.' }}"
                          >
                            <i class="material-icons" aria-hidden="true">error</i>
                            Failed
                          </span>
                        {% elif job.status == "CANCELED" %}
                          <span class="ds-status ds-status--error" title="Canceled by user.">
                            <i class="material-icons" aria-hidden="true">block</i>
                            Canceled
                          </span>
                        {% else %}
                          <span class="ds-status ds-status--processing">
                            <i class="material-icons" aria-hidden="true">autorenew</i>
                            Processing
                          </span>
                          <div class="ds-progress-inline" aria-hidden="true"></div>
                        {% endif %}
                      </td>
                      <td data-label="Actions">
                        <div class="ds-table-actions">
                          {% if job.status == "COMPLETED" %}
                            <a class="ds-button ds-button--secondary ds-button--sm ds-action-button" href="/jobs/{{ job.id }}">
                              View report
                            </a>
                          {% elif job.status == "FAILED" %}
                            <a class="ds-button ds-button--secondary ds-button--sm" href="/jobs/{{ job.id }}">
                              View error
                            </a>
                            <button class="ds-button ds-button--ghost ds-button--sm" type="button" data-retry-upload>
                              Retry
                            </button>
                          {% elif job.status == "CANCELED" %}
                            <a class="ds-button ds-button--secondary ds-button--sm" href="/jobs/{{ job.id }}">
                              View details
                            </a>
                            <button class="ds-button ds-button--ghost ds-button--sm" type="button" data-retry-upload>
                              Retry
                            </button>
                          {% else %}
                            <a class="ds-table-link" href="/jobs/{{ job.id }}">
                              View status
                            </a>
                          {% endif %}
                          <form
                            method="post"
                            action="/jobs/{{ job.id }}/delete"
                            class="ds-inline-form"
                            onsubmit="return confirm('Delete this report and uploaded file? This cannot be undone.');"
                          >
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                            <button class="ds-button ds-button--warning ds-button--sm ds-action-button" type="submit">Delete</button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </section>

  <script nonce="{{ csp_nonce }}">
    document.addEventListener("DOMContentLoaded", function () {
      var form = document.querySelector("[data-upload-form]");
      var filterForm = document.querySelector("[data-auto-submit]");

      var fileInput = form ? form.querySelector('input[type="file"]') : null;
      var submitButton = form ? form.querySelector("[data-upload-submit]") : null;
      var dropzone = form ? form.querySelector("[data-dropzone]") : null;
      var stateEl = form ? form.querySelector("[data-upload-state]") : null;
      var fileLabel = form ? form.querySelector("[data-dropzone-file]") : null;
      var uploadError = form ? form.querySelector("[data-upload-error]") : null;
      var billingBlocked = form ? form.dataset.billingDisabled === "true" : true;
      var maintenanceBlocked = form ? form.dataset.maintenanceDisabled === "true" : true;
      var maxUploadMb = form ? Number(form.dataset.maxUploadMb || "0") : 0;
      if (!isFinite(maxUploadMb) || maxUploadMb < 0) {
        maxUploadMb = 0;
      }
      var maxUploadBytes = maxUploadMb > 0 ? maxUploadMb * 1024 * 1024 : 0;

      var setUploadError = function (message) {
        if (!uploadError) return;
        uploadError.textContent = message || "";
        uploadError.hidden = !message;
      };

      var setState = function (state) {
        if (!stateEl) return;
        stateEl.setAttribute("data-upload-state", state);
      };

      var formatBytes = function (bytes) {
        var numeric = Number(bytes);
        if (!isFinite(numeric) || numeric <= 0) {
          return "0 B";
        }
        var units = ["B", "KB", "MB", "GB"];
        var size = numeric;
        var unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
          size = size / 1024;
          unitIndex += 1;
        }
        var precision = size >= 100 || unitIndex === 0 ? 0 : 1;
        return size.toFixed(precision) + " " + units[unitIndex];
      };

      var hasSupportedExtension = function (filename) {
        var value = String(filename || "").trim().toLowerCase();
        return /\.(pdf|docx)$/.test(value);
      };

      var validateFileSelection = function () {
        if (!fileInput) return false;
        if (!fileInput.files || fileInput.files.length === 0) {
          fileInput.setCustomValidity("");
          setUploadError("");
          if (fileLabel) {
            fileLabel.textContent = "No file selected";
          }
          setState("idle");
          return false;
        }

        var selected = fileInput.files[0];
        var name = selected && selected.name ? selected.name : "Selected file";
        var sizeLabel = selected && selected.size ? " (" + formatBytes(selected.size) + ")" : "";
        if (fileLabel) {
          fileLabel.textContent = name + sizeLabel;
        }

        if (!hasSupportedExtension(name)) {
          fileInput.setCustomValidity("Choose a PDF or DOCX file.");
          setUploadError("Unsupported file type. Choose a .pdf or .docx file.");
          setState("idle");
          return false;
        }

        if (maxUploadBytes > 0 && selected && selected.size > maxUploadBytes) {
          fileInput.setCustomValidity("File exceeds the upload size limit.");
          setUploadError(
            "File is too large (" + formatBytes(selected.size) + "). Maximum size is " + maxUploadMb + " MB."
          );
          setState("idle");
          return false;
        }

        fileInput.setCustomValidity("");
        setUploadError("");
        setState("selected");
        return true;
      };

      var updateSubmit = function () {
        if (!submitButton) return;
        var hasFile = fileInput && fileInput.files && fileInput.files.length > 0;
        var hasCustomError = fileInput && fileInput.validity ? fileInput.validity.customError : false;
        submitButton.disabled = billingBlocked || maintenanceBlocked || !hasFile || hasCustomError;
      };

      var workspaceResults = function () {
        return document.querySelector("[data-workspace-results]");
      };

      var syncBulkActions = function () {
        var container = workspaceResults();
        if (!container) return;
        var bulkForm = container.querySelector("#bulk-job-form");
        var selected = container.querySelectorAll("[data-job-select]:checked").length;
        var total = container.querySelectorAll("[data-job-select]").length;
        var selectAll = container.querySelector("[data-bulk-select-all]");
        var countLabel = container.querySelector("[data-bulk-count]");
        var actionSelect = container.querySelector("[data-bulk-action-select]");
        var applyButton = container.querySelector("[data-bulk-apply]");
        var hasAction = false;
        if (actionSelect) {
          hasAction = String(actionSelect.value || "").trim().length > 0;
        }

        if (selectAll) {
          selectAll.checked = total > 0 && selected === total;
          selectAll.indeterminate = selected > 0 && selected < total;
        }
        if (countLabel) {
          countLabel.textContent = selected + " selected";
        }
        if (bulkForm) {
          bulkForm.dataset.selectionState = selected > 0 ? "active" : "idle";
        }
        if (actionSelect) {
          actionSelect.disabled = total === 0;
        }
        if (applyButton) {
          applyButton.disabled = selected === 0 || !hasAction;
        }
      };

      if (fileInput) {
        fileInput.addEventListener("change", function () {
          validateFileSelection();
          updateSubmit();
        });
      }

      if (form) {
        form.addEventListener("submit", function (event) {
          var isValid = validateFileSelection();
          updateSubmit();
          if (!isValid) {
            event.preventDefault();
            if (fileInput) {
              fileInput.reportValidity();
            }
            return;
          }
          setState("uploading");
        });
      }

      if (dropzone) {
        ["dragenter", "dragover"].forEach(function (eventName) {
          dropzone.addEventListener(eventName, function (event) {
            event.preventDefault();
            if (!billingBlocked && !maintenanceBlocked) {
              dropzone.classList.add("is-dragover");
            }
          });
        });
        ["dragleave", "drop"].forEach(function (eventName) {
          dropzone.addEventListener(eventName, function (event) {
            event.preventDefault();
            dropzone.classList.remove("is-dragover");
            if (eventName !== "drop") return;
            if (billingBlocked || maintenanceBlocked) return;
            if (!fileInput) return;
            var transfer = event.dataTransfer;
            var files = transfer && transfer.files ? transfer.files : null;
            if (!files || files.length === 0) return;
            if (typeof DataTransfer !== "undefined") {
              var dt = new DataTransfer();
              dt.items.add(files[0]);
              fileInput.files = dt.files;
            } else {
              try {
                fileInput.files = files;
              } catch (err) {
                // ignore unsupported file assignment
              }
            }
            fileInput.dispatchEvent(new Event("change", { bubbles: true }));
          });
        });
      }

      document.addEventListener("click", function (event) {
        var target = event.target;
        if (!(target instanceof Element)) return;
        var retryButton = target.closest("[data-retry-upload]");
        if (!retryButton) return;
        var uploadModule = document.getElementById("upload-module");
        if (uploadModule) {
          uploadModule.scrollIntoView({ behavior: "smooth", block: "center" });
        }
        setUploadError("");
        if (fileInput && !billingBlocked && !maintenanceBlocked) {
          fileInput.focus();
        }
      });

      document.addEventListener("change", function (event) {
        var target = event.target;
        if (!(target instanceof Element)) return;
        if (target.matches("[data-bulk-select-all]")) {
          var container = workspaceResults();
          if (!container) return;
          var checked = target instanceof HTMLInputElement ? target.checked : false;
          var jobChecks = container.querySelectorAll("[data-job-select]");
          jobChecks.forEach(function (checkbox) {
            if (checkbox instanceof HTMLInputElement) {
              checkbox.checked = checked;
            }
          });
          syncBulkActions();
          return;
        }
        if (target.matches("[data-job-select]")) {
          syncBulkActions();
          return;
        }
        if (target.matches("[data-bulk-action-select]")) {
          syncBulkActions();
        }
      });

      document.addEventListener("submit", function (event) {
        var formTarget = event.target;
        if (!(formTarget instanceof HTMLFormElement)) return;
        if (formTarget.id !== "bulk-job-form") return;
        var container = workspaceResults();
        var selected = container ? container.querySelectorAll("[data-job-select]:checked").length : 0;
        var actionSelect = formTarget.querySelector("[data-bulk-action-select]");
        var action = actionSelect ? String(actionSelect.value || "").trim().toLowerCase() : "";

        if (selected === 0) {
          event.preventDefault();
          syncBulkActions();
          return;
        }
        if (!action) {
          event.preventDefault();
          syncBulkActions();
          if (actionSelect) {
            actionSelect.focus();
          }
          return;
        }
        if (action === "delete") {
          var confirmed = window.confirm("Delete selected reports and uploaded files? This cannot be undone.");
          if (!confirmed) {
            event.preventDefault();
            return;
          }
        }
      });

      updateSubmit();
      syncBulkActions();

      if (filterForm) {
        var searchInput = filterForm.querySelector("[data-search-input]");
        var autoInputs = filterForm.querySelectorAll('input[type="radio"], select');
        var resultsContainer = document.querySelector("[data-workspace-results]");
        var activeController = null;
        var submitNow = function () {
          var params = new URLSearchParams(new FormData(filterForm));
          var url = filterForm.action + (params.toString() ? "?" + params.toString() : "");
          if (!resultsContainer) {
            window.location.assign(url);
            return;
          }

          if (activeController) {
            activeController.abort();
          }
          activeController = new AbortController();
          resultsContainer.setAttribute("aria-busy", "true");
          resultsContainer.classList.add("is-loading");

          try {
            window.history.replaceState(null, "", url);
          } catch (err) {
            // ignore history errors
          }

          fetch(url, {
            signal: activeController.signal,
            headers: { "X-Requested-With": "fetch" },
          })
            .then(function (resp) {
              if (!resp.ok) {
                throw new Error("Failed to fetch results");
              }
              return resp.text();
            })
            .then(function (html) {
              if (!resultsContainer) return;
              var doc = new DOMParser().parseFromString(html, "text/html");
              var next = doc.querySelector("[data-workspace-results]");
              if (next) {
                resultsContainer.innerHTML = next.innerHTML;
                syncBulkActions();
              }
            })
            .catch(function (err) {
              if (err && err.name === "AbortError") {
                return;
              }
              window.location.assign(url);
            })
            .finally(function () {
              if (resultsContainer) {
                resultsContainer.removeAttribute("aria-busy");
                resultsContainer.classList.remove("is-loading");
              }
            });
        };

        filterForm.addEventListener("submit", function (event) {
          event.preventDefault();
          submitNow();
        });

        autoInputs.forEach(function (input) {
          input.addEventListener("change", function () {
            submitNow();
          });
        });

        if (searchInput) {
          var timer = null;
          searchInput.addEventListener("input", function () {
            if (timer) {
              window.clearTimeout(timer);
            }
            timer = window.setTimeout(function () {
              submitNow();
            }, 350);
          });

          document.addEventListener("keydown", function (event) {
            if (event.key !== "/") return;
            var target = event.target;
            if (target instanceof Element) {
              var tag = target.tagName;
              var inInput = tag === "INPUT" || tag === "TEXTAREA" || tag === "SELECT";
              if (inInput || target.isContentEditable) {
                return;
              }
            }
            event.preventDefault();
            searchInput.focus();
            searchInput.select();
          });
        }
      }
    });
  </script>
{% endblock %}
