{% extends "base.html" %}
{% block content %}
  {% set has_error = job.error_message or job.has_error %}
  <section class="ds-section">
    <div class="ds-grid">
      <div class="span-7">
        <p class="eyebrow">Report</p>
        <h1>{{ job.filename }}</h1>
        <p class="lead">
          Status: <span class="miscite-mono" id="job-status-text">{{ job.status }}</span>
        </p>
        <p class="miscite-muted">
          Reports include recommendations to improve citation coverage when available.
        </p>
        <div class="hero-meta">
          {% if public_view %}
            <span class="ds-pill">Access: token</span>
          {% else %}
            <span class="ds-pill">Job ID: {{ job.id }}</span>
          {% endif %}
          {% if has_error %}
            <span class="ds-pill">Needs attention</span>
          {% endif %}
        </div>
      </div>
      <div class="span-5">
        {% if public_view %}
          <div class="ds-card ds-card--subtle">
            <div class="card-content">
              <h3>Read-only report</h3>
              <p class="miscite-muted">
                This view is shared via access token and can show live progress until the report is ready.
                Get access to manage jobs and exports.
              </p>
	                <div class="ds-stack ds-stack--tight">
	                  <div class="hero-actions">
	                    <a class="ds-button ds-button--primary" href="/login">Get access</a>
	                  </div>
	                  <div class="ds-input-row">
	                    <div class="form-field">
	                      <label class="form-label" for="shared-report-link">Share link</label>
                    <input id="shared-report-link" class="miscite-mono" type="text" readonly value="{{ canonical_url }}" />
                  </div>
                  <button
                    class="ds-button ds-button--secondary ds-button--sm"
                    type="button"
                    data-copy-target="shared-report-link"
                  >
                    Copy link
                  </button>
                </div>
                <p class="form-help">Anyone with this link can view the report until it expires.</p>
              </div>
            </div>
          </div>
        {% else %}
          <div class="ds-card ds-card--subtle">
            <div class="card-content">
              <h3>Access token</h3>
              <p class="miscite-muted">
                Tokens are issued when a job starts and emailed to you. They expire after {{ access_token_days }} days.
              </p>
              <div class="ds-panel ds-panel--compact ds-mt-4">
                <div class="ds-panel-body">
                  {% if access_token %}
                    <p class="miscite-muted">Copy and share this token. It is shown once.</p>
                    <div class="ds-input-row">
                      <div class="form-field">
                        <label class="form-label" for="access-token-value">Access token</label>
                        <input
                          id="access-token-value"
                          class="miscite-mono"
                          type="text"
                          readonly
                          value="{{ access_token }}"
                        />
                      </div>
                      <button
                        class="ds-button ds-button--secondary ds-button--sm"
                        type="button"
                        data-copy-target="access-token-value"
                      >
                        Copy token
                      </button>
                    </div>
                    <div class="ds-input-row ds-mt-4">
                      <div class="form-field">
                        <label class="form-label" for="access-link-value">Share link</label>
                        <input
                          id="access-link-value"
                          class="miscite-mono"
                          type="text"
                          readonly
                          value="{{ public_origin }}/reports/{{ access_token }}"
                        />
                      </div>
                      <button
                        class="ds-button ds-button--secondary ds-button--sm"
                        type="button"
                        data-copy-target="access-link-value"
                      >
                        Copy link
                      </button>
                    </div>
                    <p class="form-help">Anyone with this link can view the report until it expires.</p>
                    {% if job.access_token_expires_at_human %}
                      <p class="miscite-muted">Expires {{ job.access_token_expires_at_human }}.</p>
                    {% endif %}
                  {% elif job.access_token_hint %}
                    {% if job.access_token_expired %}
                      <p class="miscite-muted">
                        Access token expired. Generate a new token to share this report.
                      </p>
                      {% if job.access_token_expires_at_human %}
                        <p class="miscite-muted">Expired {{ job.access_token_expires_at_human }}.</p>
                      {% endif %}
                      <form method="post" action="/jobs/{{ job.id }}/access-token">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                        <button class="ds-button ds-button--secondary ds-button--sm" type="submit">Generate token</button>
                      </form>
                    {% else %}
                      <p class="miscite-muted">
                        Active token ending in <span class="miscite-mono">{{ job.access_token_hint }}</span>.
                      </p>
                      {% if job.access_token_expires_at_human %}
                        <p class="miscite-muted">Expires {{ job.access_token_expires_at_human }}.</p>
                      {% endif %}
                      <form method="post" action="/jobs/{{ job.id }}/access-token">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                        <button class="ds-button ds-button--ghost ds-button--sm" type="submit">Rotate token</button>
                      </form>
                    {% endif %}
                  {% else %}
                    <p class="miscite-muted">A token will be emailed when the job starts. You can also generate one now.</p>
                    <form method="post" action="/jobs/{{ job.id }}/access-token">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                      <button class="ds-button ds-button--secondary ds-button--sm" type="submit">
                        Generate token
                      </button>
                    </form>
                  {% endif %}
                </div>
              </div>
              <div class="ds-panel ds-panel--compact ds-mt-4">
                <div class="ds-panel-body">
                  <p class="eyebrow">Exports</p>
                  <div class="ds-input-row">
                    <div class="form-field">
                      <label class="form-label" for="job-json-url">Report JSON</label>
                      <input
                        id="job-json-url"
                        class="miscite-mono"
                        type="text"
                        readonly
                        value="{{ public_origin }}/api/jobs/{{ job.id }}"
                      />
                    </div>
                    <button
                      class="ds-button ds-button--secondary ds-button--sm"
                      type="button"
                      data-copy-target="job-json-url"
                    >
                      Copy URL
                    </button>
	                  </div>
	                  <p class="form-help">Fetch report JSON for downstream review and exports.</p>
	                </div>
	              </div>
	            </div>
	          </div>
        {% endif %}
      </div>
    </div>
    {% if job.error_message and not public_view %}
      <div class="ds-alert ds-alert--error ds-mt-5">
        {{ job.error_message }}
      </div>
    {% elif public_view and has_error %}
      <div class="ds-alert ds-alert--error ds-mt-5">
        This analysis encountered an error. Please ask the report owner to retry.
      </div>
    {% endif %}
  </section>

  {% if job.status != "COMPLETED" %}
    <section class="ds-section" id="job-progress-section" data-job-id="{{ job.id }}">
      <div class="ds-card">
        <div class="card-content">
          <div class="ds-progress-header">
            <h3>Live progress</h3>
            <span class="ds-pill" id="job-status-pill">{{ job.status }}</span>
          </div>
          <div class="ds-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="2">
            <div class="ds-progress-fill" id="job-progress-fill" style="width: 2%"></div>
          </div>
          <p class="miscite-muted ds-mt-3" id="job-progress-text">Waiting for worker...</p>
          <ul class="ds-progress-log" id="job-progress-log" aria-live="polite"></ul>
        </div>
      </div>
    </section>
	  {% endif %}
	
	  {% if report %}
	    {% set issues = report.issues|default([]) %}
	    {% set severity_counts = namespace(high=0, medium=0, low=0) %}
	    {% set summary_counts = namespace(missing=0, unresolved=0, retracted=0, predatory=0, potential=0) %}
	    {% for issue in issues %}
	      {% set sev = issue.severity|default('medium')|lower %}
	      {% if sev == 'high' %}
	        {% set severity_counts.high = severity_counts.high + 1 %}
	      {% elif sev == 'low' %}
	        {% set severity_counts.low = severity_counts.low + 1 %}
	      {% else %}
	        {% set severity_counts.medium = severity_counts.medium + 1 %}
	      {% endif %}
	      {% if issue.type == 'missing_bibliography_ref' %}
	        {% set summary_counts.missing = summary_counts.missing + 1 %}
	      {% elif issue.type == 'unresolved_reference' %}
	        {% set summary_counts.unresolved = summary_counts.unresolved + 1 %}
	      {% elif issue.type == 'retracted_article' %}
	        {% set summary_counts.retracted = summary_counts.retracted + 1 %}
	      {% elif issue.type == 'predatory_venue_match' %}
	        {% set summary_counts.predatory = summary_counts.predatory + 1 %}
	      {% elif issue.type in ['potentially_inappropriate', 'needs_manual_review'] %}
	        {% set summary_counts.potential = summary_counts.potential + 1 %}
	      {% endif %}
	    {% endfor %}
	    {% set summary = report.summary or {} %}
	    <section class="ds-section">
	      <div class="ds-grid">
        <div class="span-5">
          <div class="ds-card">
            <div class="card-content">
              <h3>Summary</h3>
	              <div class="ds-stat-grid">
	                <div class="ds-stat">
	                  <div class="ds-stat-value">{{ summary.total_citations|default(0) }}</div>
	                  <div class="ds-stat-label">Citations parsed</div>
	                </div>
	                <div class="ds-stat">
	                  <div class="ds-stat-value">{{ summary_counts.missing }}</div>
	                  <div class="ds-stat-label">Missing refs</div>
	                </div>
	                <div class="ds-stat">
	                  <div class="ds-stat-value">{{ summary_counts.unresolved }}</div>
	                  <div class="ds-stat-label">Unresolved</div>
	                </div>
	                <div class="ds-stat">
	                  <div class="ds-stat-value">{{ summary_counts.retracted }}</div>
	                  <div class="ds-stat-label">Retractions</div>
	                </div>
	                <div class="ds-stat">
	                  <div class="ds-stat-value">{{ summary_counts.predatory }}</div>
	                  <div class="ds-stat-label">Venue risk</div>
	                </div>
	                <div class="ds-stat">
	                  <div class="ds-stat-value">{{ summary_counts.potential }}</div>
	                  <div class="ds-stat-label">Potential issues</div>
	                </div>
	              </div>
            </div>
          </div>
        </div>
        <div class="span-7">
          <div class="ds-card">
	            <div class="card-content">
	              <h3>Flags</h3>
	              <p class="miscite-muted">Review issues by severity, with context and suggested next steps.</p>
	              {% if issues|length > 0 %}
	                <div class="ds-severity-grid ds-mt-4">
	                  <button
	                    type="button"
                    class="ds-severity-card ds-severity-card--high js-severity-filter"
                    data-severity-filter="high"
                    aria-pressed="false"
                    aria-label="Filter to high severity issues"
                  >
                    <div class="ds-severity-count">{{ severity_counts.high }}</div>
                    <div class="ds-severity-label">High severity</div>
                  </button>
                  <button
                    type="button"
                    class="ds-severity-card ds-severity-card--medium js-severity-filter"
                    data-severity-filter="medium"
                    aria-pressed="false"
                    aria-label="Filter to medium severity issues"
                  >
                    <div class="ds-severity-count">{{ severity_counts.medium }}</div>
                    <div class="ds-severity-label">Medium severity</div>
                  </button>
                  <button
                    type="button"
                    class="ds-severity-card ds-severity-card--low js-severity-filter"
                    data-severity-filter="low"
                    aria-pressed="false"
                    aria-label="Filter to low severity issues"
                  >
                    <div class="ds-severity-count">{{ severity_counts.low }}</div>
                    <div class="ds-severity-label">Low severity</div>
	                  </button>
	                </div>
	              {% endif %}
	              {% if issues|length == 0 %}
	                <div class="ds-empty">
	                  <h4>No issues flagged</h4>
	                  <p class="miscite-muted">This report did not surface any flagged citations.</p>
	                </div>
	              {% else %}
	                <div class="ds-disclosure-list">
	                  {% for issue in issues %}
	                    {% set raw_severity = issue.severity|default('medium')|lower %}
	                    {% set severity = raw_severity if raw_severity in ['high', 'medium', 'low'] else 'medium' %}
	                    {% set details = issue.details or {} %}
                    {% set citation = details.citation or {} %}
                    {% set resolution = details.resolution or {} %}
                    {% set issue_label = issue.type %}
                    {% set issue_description = "" %}
                    {% set issue_action = "" %}
                    {% if issue.type == "missing_bibliography_ref" %}
                      {% set issue_label = "Missing bibliography entry" %}
                      {% set issue_description = "The in-text citation does not appear in the bibliography list." %}
                      {% set issue_action = "Add a matching bibliography entry or correct the citation formatting." %}
                    {% elif issue.type == "unresolved_reference" %}
                      {% set issue_label = "Unresolved reference" %}
                      {% set issue_description = "We found the bibliography entry but could not match it to metadata." %}
                      {% set issue_action = "Verify DOI, title, author, or year in the bibliography entry." %}
                    {% elif issue.type == "retracted_article" %}
                      {% set issue_label = "Retracted work cited" %}
                      {% set issue_description = "This reference matches a retracted record." %}
                      {% set issue_action = "Consider replacing the reference or clearly noting the retraction context." %}
                    {% elif issue.type == "predatory_venue_match" %}
                      {% set issue_label = "Venue risk match" %}
                      {% set issue_description = "The journal or publisher matches a venue risk watchlist." %}
                      {% set issue_action = "Confirm the venue quality before citing." %}
                    {% elif issue.type == "potentially_inappropriate" %}
                      {% set issue_label = "Potentially inappropriate citation" %}
                      {% set issue_description = "The citation context appears misaligned with the cited work." %}
                      {% set issue_action = "Review the surrounding text and ensure relevance." %}
                    {% elif issue.type == "needs_manual_review" %}
                      {% set issue_label = "Needs manual review" %}
                      {% set issue_description = "Automated checks could not verify this citation." %}
                      {% set issue_action = "Review the citation manually for accuracy." %}
                    {% endif %}
                    <details
                      class="ds-disclosure ds-disclosure--{{ severity }} js-issue"
                      data-severity="{{ severity }}"
                    >
                      <summary class="ds-disclosure-summary">
                        <i class="material-icons ds-disclosure-icon" aria-hidden="true">flag</i>
                        <span class="ds-severity" aria-label="Severity {{ severity }}">{{ severity }}</span>
                        <span class="ds-disclosure-type">{{ issue_label }}</span>
                        <span class="ds-disclosure-title">{{ issue.title }}</span>
                        <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                      </summary>
                      <div class="ds-disclosure-body">
                        <div class="ds-issue-grid">
                          <div class="ds-issue-summary">
                            <h4>{{ issue_label }}</h4>
                            {% if issue_description %}
                              <p class="miscite-muted">{{ issue_description }}</p>
                            {% endif %}
                            {% if issue_action %}
                              <p class="ds-issue-guidance">{{ issue_action }}</p>
                            {% endif %}
                            <dl class="ds-meta">
                              {% if details.ref_id is defined %}
                                <dt>Reference ID</dt>
                                <dd class="miscite-mono">{{ details.ref_id }}</dd>
                              {% endif %}
                              {% if citation.raw %}
                                <dt>In-text citation</dt>
                                <dd class="miscite-mono">{{ citation.raw }}</dd>
                              {% endif %}
                              {% if citation.locator %}
                                <dt>Locator</dt>
                                <dd class="miscite-mono">{{ citation.locator }}</dd>
                              {% endif %}
                              {% if resolution.title %}
                                <dt>Title</dt>
                                <dd>{{ resolution.title }}</dd>
                              {% endif %}
                              {% if resolution.doi %}
                                <dt>DOI</dt>
                                <dd class="miscite-mono">{{ resolution.doi }}</dd>
                              {% endif %}
                              {% if resolution.journal %}
                                <dt>Journal</dt>
                                <dd>{{ resolution.journal }}</dd>
                              {% endif %}
                              {% if resolution.publisher %}
                                <dt>Publisher</dt>
                                <dd>{{ resolution.publisher }}</dd>
                              {% endif %}
                              {% if resolution.year %}
                                <dt>Year</dt>
                                <dd>{{ resolution.year }}</dd>
                              {% endif %}
                              {% if resolution.confidence is defined %}
                                <dt>Resolution confidence</dt>
                                <dd>{{ "%.2f"|format(resolution.confidence) }}</dd>
                              {% endif %}
                            </dl>
                            {% if details.retraction %}
                              <div class="ds-chip-row" aria-label="Retraction signals">
                                <span class="ds-chip">Retraction signal detected</span>
                                <span class="ds-chip">Verified registries</span>
                              </div>
                            {% endif %}
                            {% if details.match %}
                              <div class="ds-chip-row" aria-label="Venue risk signals">
                                <span class="ds-chip">Venue risk signal detected</span>
                                <span class="ds-chip">Curated watchlists</span>
                              </div>
                            {% endif %}
                            {% if details.nli %}
                              <div class="ds-chip-row" aria-label="Automated signals">
                                <span class="ds-chip">Automated signal: {{ details.nli.label }}</span>
                                <span class="ds-chip">Confidence: {{ "%.2f"|format(details.nli.confidence) }}</span>
                              </div>
                            {% elif details.llm %}
                              <div class="ds-chip-row" aria-label="Automated signals">
                                <span class="ds-chip">Automated signal: {{ details.llm.label }}</span>
                                <span class="ds-chip">Confidence: {{ "%.2f"|format(details.llm.confidence) }}</span>
                              </div>
                            {% endif %}
                          </div>
                          <div class="ds-issue-context">
                            <h4>Context</h4>
                            {% if citation.context %}
                              <p class="ds-quote">{{ citation.context }}</p>
                            {% else %}
                              <p class="miscite-muted">No context available for this citation.</p>
                            {% endif %}
                            {% if details.raw %}
                              <p class="ds-issue-caption">Bibliography entry</p>
                              <p class="ds-quote miscite-mono">{{ details.raw }}</p>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </details>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </section>

    {% if report.deep_analysis %}
      <section class="ds-section">
        <div class="ds-card">
          <div class="card-content">
            <h3>Recommendations</h3>
            <p class="miscite-muted">
              Proprietary relevance analysis suggests additional references and improvement opportunities.
              Use the <span class="miscite-mono">[R#]</span> markers to jump to the reference list for this section.
            </p>

            {% if report.deep_analysis.status == "completed" %}
              {% set da = report.deep_analysis %}
              {% set sug = da.suggestions %}

              {% if sug and sug.status == "completed" %}
                {% if sug.overview %}
                  <p class="ds-issue-guidance">{{ sug.overview|da_cite }}</p>
                {% endif %}
                {% if sug.note %}
                  <p class="miscite-muted">{{ sug.note }}</p>
                {% endif %}
                {% if sug.sections %}
                  <div class="ds-stack ds-mt-4">
                    {% for section in sug.sections %}
                      <div>
                        <h4>{{ section.title }}</h4>
                        {% if section.bullets %}
                          <ul class="ds-list ds-mt-3">
                            {% for bullet in section.bullets %}
                              <li>{{ bullet|da_cite }}</li>
                            {% endfor %}
                          </ul>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
              {% else %}
                <p class="miscite-muted">No recommendations were generated for this run.</p>
              {% endif %}

              {% if da.citation_groups and da.references %}
                <h4 class="ds-mt-5">Shortlists</h4>
                <p class="miscite-muted">
                  Quick lists used by the suggestions above (each item links to the master reference list).
                </p>
                <div class="ds-grid ds-mt-4">
                  {% for group in da.citation_groups %}
                    {% set rids = group.rids|default([]) %}
                    <div class="span-6 ds-mt-4">
                      <details class="ds-disclosure ds-disclosure--low" open>
                        <summary class="ds-disclosure-summary">
                          <i class="material-icons ds-disclosure-icon" aria-hidden="true">bookmark</i>
                          <span class="ds-disclosure-type">List</span>
                          <span class="ds-disclosure-title">{{ group.title }}</span>
                          <span class="ds-severity">{{ rids|length }} refs</span>
                          <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                        </summary>
                        <div class="ds-disclosure-body">
                          <ul class="ds-list">
                            {% for rid in rids %}
                              {% set ref = da.references.get(rid) %}
                              {% if ref %}
                                <li>
                                  <div>
                                    <a class="miscite-mono" href="#da-ref-{{ rid }}">[{{ rid }}]</a>
                                    {{ ref.title|default("Untitled") }}
                                    {% if ref.year %} ({{ ref.year }}){% endif %}
                                  </div>
                                  {% if ref.in_paper %}
                                    <div class="ds-chip-row ds-mt-3" aria-label="Reference status">
                                      <span class="ds-chip ds-chip--success">Already cited</span>
                                    </div>
                                  {% endif %}
                                </li>
                              {% endif %}
                            {% endfor %}
                          </ul>
                        </div>
                      </details>
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              {% if da.reference_groups and da.references %}
                <h4 class="ds-mt-5">Reference list for this section</h4>
                <p class="miscite-muted">
                  Each reference appears once (grouped); click <span class="miscite-mono">[R#]</span> anywhere above to jump
                  here.
                </p>
                <div class="ds-stack ds-mt-4">
                  {% for group in da.reference_groups %}
                    {% set rids = group.rids|default([]) %}
                    <details class="ds-disclosure ds-disclosure--low" {% if loop.index <= 2 %}open{% endif %}>
                      <summary class="ds-disclosure-summary">
                        <i class="material-icons ds-disclosure-icon" aria-hidden="true">menu_book</i>
                        <span class="ds-disclosure-type">Group</span>
                        <span class="ds-disclosure-title">{{ group.title }}</span>
                        <span class="ds-severity">{{ rids|length }} refs</span>
                        <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                      </summary>
                      <div class="ds-disclosure-body">
                        <ol class="ds-list">
                          {% for rid in rids %}
                            {% set ref = da.references.get(rid) %}
                            {% if ref %}
                              <li id="da-ref-{{ rid }}">
                                <div>
                                  <span class="miscite-mono">[{{ rid }}]</span>
                                  {{ ref.apa_base }}
                                </div>
                                <div class="ds-chip-row ds-mt-3" aria-label="Reference links">
                                  {% if ref.doi %}
                                    <a
                                      class="ds-chip miscite-mono"
                                      href="https://doi.org/{{ ref.doi }}"
                                      target="_blank"
                                      rel="noopener noreferrer"
                                    >
                                      DOI: {{ ref.doi }}
                                    </a>
                                  {% else %}
                                    {% set safe_url = ref.official_url|safe_url %}
                                    {% if safe_url %}
                                      <a
                                        class="ds-chip miscite-mono"
                                        href="{{ safe_url }}"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                      >
                                        URL: {{ safe_url }}
                                      </a>
                                    {% endif %}
                                  {% endif %}
                                  {% set safe_pdf = ref.oa_pdf_url|safe_url %}
                                  {% if safe_pdf %}
                                    <a class="ds-chip" href="{{ safe_pdf }}" target="_blank" rel="noopener noreferrer">
                                      Open PDF
                                    </a>
                                  {% endif %}
                                  {% if ref.in_paper %}
                                    <span class="ds-chip ds-chip--success">Already cited</span>
                                  {% endif %}
                                </div>
                              </li>
                            {% endif %}
                          {% endfor %}
                        </ol>
                      </div>
                    </details>
                  {% endfor %}
                </div>
              {% endif %}

            {% elif report.deep_analysis.status == "skipped" %}
              <p class="miscite-muted">{{ report.deep_analysis.reason|default("Recommendations were skipped.") }}</p>
            {% else %}
              <div class="ds-alert ds-alert--warning ds-mt-4">
                Recommendations did not complete: {{ report.deep_analysis.reason|default("Unknown error") }}
              </div>
            {% endif %}
          </div>
        </div>
      </section>
    {% endif %}


    {% if report.deep_analysis and report.deep_analysis.status == "completed" and report.deep_analysis.references %}
      {% set da = report.deep_analysis %}
      <section class="ds-section">
        <div class="ds-card">
          <div class="card-content">
            <h3>Complete reference list</h3>
            <p class="miscite-muted">All deep-analysis references, alphabetized by author.</p>
            {% set all_refs = da.references.values()|list|sort(attribute='apa_base') %}
            <ol class="ds-list ds-mt-3">
              {% for ref in all_refs %}
                <li>
                  <div>
                    <span class="miscite-mono">[{{ ref.rid }}]</span>
                    {{ ref.apa_base }}
                  </div>
                  {% if ref.in_paper %}
                    <div class="ds-chip-row ds-mt-3" aria-label="Reference status">
                      <span class="ds-chip ds-chip--success">Already cited</span>
                    </div>
                  {% endif %}
                </li>
              {% endfor %}
            </ol>
          </div>
        </div>
      </section>
    {% endif %}

    {% if not public_view %}
      <section class="ds-section">
        <div class="ds-card">
          <div class="card-content">
            <h3>Audit trail</h3>
            <p class="miscite-muted">
              Sources, methodology notes, and exports for traceability and downstream review.
            </p>
            <div class="ds-disclosure-list ds-mt-4">
              {% if data_sources %}
                <details class="ds-disclosure ds-disclosure--low">
                  <summary class="ds-disclosure-summary">
                    <i class="material-icons ds-disclosure-icon" aria-hidden="true">database</i>
                    <span class="ds-disclosure-type">Sources</span>
                    <span class="ds-disclosure-title">Data sources used</span>
                    <span class="ds-severity">{{ data_sources|length }}</span>
                    <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                  </summary>
                  <div class="ds-disclosure-body">
                    <dl class="ds-meta">
                      {% for src in data_sources %}
                        <dt>{{ src.name }}</dt>
                        <dd>{{ src.detail }}</dd>
                      {% endfor %}
                    </dl>
                  </div>
                </details>
              {% endif %}

              {% if methodology_md %}
                <details class="ds-disclosure ds-disclosure--low">
                  <summary class="ds-disclosure-summary">
                    <i class="material-icons ds-disclosure-icon" aria-hidden="true">description</i>
                    <span class="ds-disclosure-type">Method</span>
                    <span class="ds-disclosure-title">Methodology notes</span>
                    <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                  </summary>
                  <div class="ds-disclosure-body">
                    <pre class="pre-wrap ds-pre-scroll">{{ methodology_md }}</pre>
                  </div>
                </details>
              {% endif %}

              <details class="ds-disclosure ds-disclosure--low">
                <summary class="ds-disclosure-summary">
                  <i class="material-icons ds-disclosure-icon" aria-hidden="true">data_object</i>
                  <span class="ds-disclosure-type">Export</span>
                  <span class="ds-disclosure-title">Raw report JSON</span>
                  <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                </summary>
                <div class="ds-disclosure-body">
                  <pre class="pre-wrap ds-pre-scroll">{{ report|pretty_json }}</pre>
                </div>
              </details>
            </div>
          </div>
        </div>
      </section>
    {% endif %}
  {% else %}
    <section class="ds-section">
      <div class="ds-empty">
        <h4>Report not available yet</h4>
        <p class="miscite-muted">Refresh in a moment to view the generated summary.</p>
        {% if public_view %}
          <a class="ds-button ds-button--secondary" href="{{ request.url.path }}">Refresh report</a>
        {% else %}
          <a class="ds-button ds-button--secondary" href="/jobs/{{ job.id }}">Refresh report</a>
        {% endif %}
      </div>
    </section>
  {% endif %}
  <script nonce="{{ csp_nonce }}">
    (function () {
      var section = document.getElementById("job-progress-section");
      if (!section) {
        return;
      }

      var publicView = {{ "true" if public_view else "false" }};
      var accessToken = null;
      if (publicView) {
        var match = window.location.pathname.match(/^\/reports\/([^/]+)$/);
        if (match) {
          accessToken = decodeURIComponent(match[1]);
        }
        if (!accessToken) {
          return;
        }
      }

      var jobId = section.getAttribute("data-job-id");
      var statusText = document.getElementById("job-status-text");
      var statusPill = document.getElementById("job-status-pill");
      var progressFill = document.getElementById("job-progress-fill");
      var progressText = document.getElementById("job-progress-text");
      var progressLog = document.getElementById("job-progress-log");

      var lastEventId = 0;
      var lastProgress = 2;
      var terminal = { COMPLETED: true, FAILED: true };

      var setStatus = function (status) {
        var value = status || "UNKNOWN";
        if (statusText) {
          statusText.textContent = value;
        }
        if (statusPill) {
          statusPill.textContent = value;
        }
      };

      var setProgress = function (progress, message) {
        if (typeof progress === "number") {
          var pct = Math.max(2, Math.min(100, Math.round(progress * 100)));
          if (pct >= lastProgress) {
            lastProgress = pct;
            if (progressFill && progressFill.parentElement) {
              progressFill.style.width = pct + "%";
              progressFill.parentElement.setAttribute("aria-valuenow", String(pct));
            }
          }
        }
        if (message && progressText) {
          progressText.textContent = message;
        }
      };

      var appendLog = function (payload) {
        if (!progressLog || !payload) {
          return;
        }
        var message = payload.message || payload.stage || "Update";
        var item = document.createElement("li");
        item.className = "ds-progress-item";
        item.textContent = message;
        progressLog.prepend(item);
        var maxItems = 8;
        while (progressLog.children.length > maxItems) {
          progressLog.removeChild(progressLog.lastChild);
        }
      };

      var handleDone = function (status) {
        if (status === "FAILED") {
          setProgress(1.0, "Job failed.");
          return;
        }
        setProgress(1.0, "Analysis complete. Refreshing...");
        setTimeout(function () {
          window.location.reload();
        }, 1200);
      };

      var handleProgress = function (payload) {
        if (!payload) {
          return;
        }
        if (payload.id && payload.id > lastEventId) {
          lastEventId = payload.id;
        }
        setProgress(payload.progress, payload.message || payload.stage);
        appendLog(payload);
      };

      var handleStatus = function (payload) {
        if (!payload) {
          return;
        }
        setStatus(payload.status);
        if (terminal[payload.status || ""]) {
          handleDone(payload.status);
        }
      };

      var eventsPath = publicView ? "/api/reports/" + accessToken + "/events" : "/api/jobs/" + jobId + "/events";
      var streamUrl = publicView ? "/api/reports/" + accessToken + "/stream" : "/api/jobs/" + jobId + "/stream";

      var poll = function () {
        fetch(eventsPath + "?since_id=" + lastEventId, {
          headers: { Accept: "application/json" },
          cache: "no-store",
        })
          .then(function (resp) {
            return resp.ok ? resp.json() : null;
          })
          .then(function (data) {
            if (!data) {
              return;
            }
            if (Array.isArray(data.events)) {
              data.events.forEach(handleProgress);
            }
            handleStatus(data);
          })
          .catch(function () {
            // ignore polling errors
          });
      };

      var connect = function () {
        if (!window.EventSource) {
          setInterval(poll, 2000);
          poll();
          return;
        }
        var source = new EventSource(streamUrl);
        source.addEventListener("progress", function (event) {
          try {
            handleProgress(JSON.parse(event.data));
          } catch (err) {
            // ignore parse errors
          }
        });
        source.addEventListener("status", function (event) {
          try {
            handleStatus(JSON.parse(event.data));
          } catch (err) {
            // ignore parse errors
          }
        });
        source.addEventListener("done", function (event) {
          try {
            handleDone(JSON.parse(event.data).status);
          } catch (err) {
            handleDone("COMPLETED");
          }
          source.close();
        });
        source.onerror = function () {
          source.close();
          setInterval(poll, 2000);
          poll();
        };
      };

      connect();
    })();
  </script>
  <script nonce="{{ csp_nonce }}">
    (function () {
      var buttons = document.querySelectorAll("[data-severity-filter]");
      if (!buttons.length) {
        return;
      }
      var issues = document.querySelectorAll(".js-issue[data-severity]");
      var active = null;

      var setActive = function (severity) {
        active = severity;
        buttons.forEach(function (btn) {
          var isActive = btn.getAttribute("data-severity-filter") === severity;
          btn.classList.toggle("is-active", isActive);
          btn.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
        issues.forEach(function (issue) {
          var match = issue.getAttribute("data-severity") === severity;
          issue.hidden = !match;
        });
      };

      var clearActive = function () {
        active = null;
        buttons.forEach(function (btn) {
          btn.classList.remove("is-active");
          btn.setAttribute("aria-pressed", "false");
        });
        issues.forEach(function (issue) {
          issue.hidden = false;
        });
      };

      buttons.forEach(function (btn) {
        btn.addEventListener("click", function (event) {
          event.stopPropagation();
          var severity = btn.getAttribute("data-severity-filter");
          if (!severity) {
            return;
          }
          if (active === severity) {
            clearActive();
          } else {
            setActive(severity);
          }
        });
      });

      document.addEventListener("click", function (event) {
        if (!active) {
          return;
        }
        if (event.target.closest("[data-severity-filter]")) {
          return;
        }
        clearActive();
      });
    })();
  </script>
{% endblock %}
