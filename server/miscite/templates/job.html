{% extends "base.html" %}
{% block content %}
  {% set has_error = job.error_message or job.has_error %}
  {% set da = report.deep_analysis if report and report.deep_analysis is mapping else None %}
  {% set da_status = da.status|default("") if da else "" %}
  {% set potential_reviewers = da.potential_reviewers|default([], true) if da else [] %}
  {% set reviewers_defined = (da.potential_reviewers is defined) if da else false %}
  <section class="ds-section" id="report-top">
    <div class="ds-grid">
      <div class="span-7">
        <p class="eyebrow">Report</p>
        <h1>{{ job.filename }}</h1>
        <p class="lead">
          Status: <span class="miscite-mono" id="job-status-text">{{ job.status }}</span>
        </p>
        <p class="miscite-muted">
          Review summary metrics, flagged issues, and recommendations in one place.
        </p>
        <div class="hero-meta">
          {% if public_view %}
            <span class="ds-pill">Access: token</span>
          {% else %}
            <span class="ds-pill">Job ID: {{ job.id }}</span>
          {% endif %}
          {% if has_error %}
            <span class="ds-pill">Needs attention</span>
          {% endif %}
        </div>
        {% if not public_view %}
          <div class="hero-actions">
            <a class="ds-button ds-button--ghost ds-button--sm" href="/dashboard">Back to workspace</a>
            <a class="ds-button ds-button--secondary ds-button--sm" href="#report-flags">Jump to flags</a>
          </div>
        {% endif %}
        <div class="ds-card ds-card--subtle ds-mt-4" id="report-reviewers">
          <div class="card-content">
            <div class="ds-card-header--split">
              <h4>Potential reviewers</h4>
              {% if not report %}
                <span class="ds-pill">pending</span>
              {% elif not da %}
                <span class="ds-pill">unavailable</span>
              {% elif da_status == "completed" and reviewers_defined %}
                <span class="ds-pill">{{ potential_reviewers|length }} suggested</span>
              {% elif da_status == "completed" %}
                <span class="ds-pill">unavailable</span>
              {% else %}
                <span class="ds-pill">{{ da_status or "pending" }}</span>
              {% endif %}
            </div>

            {% if not report %}
              <p class="miscite-muted">
                Reviewer suggestions become available once the report is ready.
              </p>
            {% elif not da %}
              <p class="miscite-muted">
                This report does not include deep-analysis metadata. Generate a new report to compute potential reviewers.
              </p>
            {% elif da_status != "completed" %}
              <p class="miscite-muted">
                This section is generated from citation-coupled works (articles that cite many of your references).
              </p>
              {% if da_status == "skipped" %}
                <p class="miscite-muted">{{ da.reason|default("Deep analysis was skipped.") }}</p>
              {% elif da_status == "failed" %}
                <p class="miscite-muted">Deep analysis failed: {{ da.reason|default("Unknown error") }}</p>
              {% else %}
                <p class="miscite-muted">Reviewer suggestions will appear when deep analysis completes.</p>
              {% endif %}
            {% elif not reviewers_defined %}
              <p class="miscite-muted">
                This report was generated before reviewer suggestions were computed. Generate a new report to include potential reviewers.
              </p>
            {% else %}
              {% if potential_reviewers and potential_reviewers|length > 0 %}
                <div class="report-reviewers-scroll">
                  <ul class="ds-list report-reviewers-list">
                    {% for reviewer in potential_reviewers %}
                      {% set safe_search_url = reviewer.google_search_url|safe_url %}
                      <li class="report-reviewer-item">
                        <div class="report-reviewer-line">
                          {% if safe_search_url %}
                            <a class="ds-link" href="{{ safe_search_url }}" target="_blank" rel="noopener noreferrer">{{ reviewer.name }}</a>
                          {% else %}
                            <span class="ds-source-name">{{ reviewer.name }}</span>
                          {% endif %}
                          <span class="miscite-muted report-reviewer-affiliation">â€” {{ reviewer.affiliation or "Affiliation unavailable" }}</span>
                        </div>
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% else %}
                <p class="miscite-muted">No reviewer candidates were found for this run.</p>
                {% if da.lit_pool is mapping and da.lit_pool.citing_refs|default(0) == 0 %}
                  <p class="miscite-muted">
                    Deep analysis did not collect any recent papers citing your key references (often due to strict node/edge limits). Try rerunning with a higher node budget.
                  </p>
                {% endif %}
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
      <div class="span-5">
        {% if public_view %}
          <div class="ds-card ds-card--subtle">
            <div class="card-content">
              <div class="ds-card-header--split">
                <h3>Read-only report</h3>
                {% if report_pdf_url %}
                  <a class="ds-button ds-button--secondary ds-button--sm" href="{{ report_pdf_url }}">
                    Download PDF
                  </a>
                {% endif %}
              </div>
              <p class="miscite-muted">
                This view is shared via access token and can show live progress until the report is ready.
                Get access to manage jobs and exports.
              </p>
              <div class="ds-stack ds-stack--tight">
                <div class="ds-input-row">
                  <div class="form-field">
                    <label class="form-label" for="shared-report-link">Share link</label>
                    <input id="shared-report-link" class="miscite-mono" type="text" readonly value="{{ canonical_url }}" />
                  </div>
                  <button
                    class="ds-button ds-button--secondary ds-button--sm"
                    type="button"
                    data-copy-target="shared-report-link"
                  >
                    Copy link
                  </button>
                </div>
                <p class="form-help">Anyone with this link can view the report until it expires.</p>
              </div>
            </div>
          </div>
        {% else %}
          {% set token_value = access_token or job.access_token_value %}
          {% set share_link = token_value and (public_origin ~ "/reports/" ~ token_value) %}
          {% set sharing_enabled = job.access_token_enabled %}
          {% set has_token = token_value or job.access_token_hint %}
          {% set share_link_ready = sharing_enabled and (not job.access_token_expired) and share_link %}
          {% set share_link_display = share_link if share_link_ready else "" %}
          {% set share_link_placeholder = "Turn sharing on and rotate token to generate a link" %}
          {% if sharing_enabled and job.access_token_expired %}
            {% set share_link_placeholder = "Token expired. Renew token to restore sharing" %}
          {% elif sharing_enabled and not share_link %}
            {% set share_link_placeholder = "Rotate token to reveal a new link" %}
          {% endif %}
          {% set state_sentence = "Sharing is off. Turn sharing on to generate a secure link." %}
          {% if sharing_enabled and job.access_token_expired %}
            {% set state_sentence = "Sharing is on, but the token is expired. Renew it to restore access." %}
          {% elif sharing_enabled %}
            {% set state_sentence = "Sharing is on. Anyone with the link can open this report." %}
          {% endif %}
          <div class="ds-card ds-card--subtle">
            <div class="card-content">
              <div class="ds-card-header--split share-access-header">
                <div class="share-access-header-main">
                  <h3>Share access</h3>
                  {% if report_pdf_url %}
                    <a class="ds-button ds-button--secondary ds-button--sm" href="{{ report_pdf_url }}">
                      Download PDF
                    </a>
                  {% endif %}
                </div>
                <div class="share-access-header-actions">
                  <form method="post" action="/jobs/{{ job.id }}/sharing" id="sharing-toggle-form">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <button
                      class="ds-button {% if sharing_enabled %}ds-button--secondary{% else %}ds-button--primary{% endif %} ds-button--sm"
                      type="submit"
                      name="action"
                      id="sharing-toggle-button"
                      data-sharing-toggle="{% if sharing_enabled %}on{% else %}off{% endif %}"
                      value="{% if sharing_enabled %}disable{% else %}enable{% endif %}"
                    >
                      {% if sharing_enabled %}
                        Turn off
                      {% else %}
                        Turn on
                      {% endif %}
                    </button>
                  </form>
                  <span class="ds-pill">State: {% if sharing_enabled %}Shareable{% else %}Protected{% endif %}</span>
                </div>
              </div>
              <p class="miscite-muted">{{ state_sentence }}</p>
              <p class="form-help share-inline-status" id="share-inline-status" role="status" aria-live="polite"></p>
              <div class="share-toast" id="share-toast" role="status" aria-live="polite" aria-atomic="true" hidden></div>
              {% if sharing_enabled %}
                <div class="ds-panel ds-panel--compact ds-mt-4">
                  <div class="ds-panel-body ds-stack ds-stack--tight share-access-panel-body">
                    <div class="ds-input-row">
                      <div class="form-field">
                        <label class="form-label form-label--normal" for="access-link-value">Share link</label>
                        <input
                          id="access-link-value"
                          class="miscite-mono"
                          type="text"
                          readonly
                          placeholder="{{ share_link_placeholder }}"
                          value="{{ share_link_display }}"
                        />
                      </div>
                      <button
                        class="ds-button ds-button--primary ds-button--sm"
                        type="button"
                        data-copy-target="access-link-value"
                        {% if not share_link_ready %}disabled{% endif %}
                      >
                        Copy link
                      </button>
                      <a
                        class="ds-button ds-button--secondary ds-button--sm"
                        id="share-link-open"
                        href="{{ share_link if share_link_ready else '#' }}"
                        target="_blank"
                        rel="noopener"
                        aria-disabled="{% if not share_link_ready %}true{% else %}false{% endif %}"
                        {% if not share_link_ready %}tabindex="-1"{% endif %}
                      >
                        Open
                      </a>
                    </div>
                    {% if share_link_ready and job.access_token_expires_at_human %}
                      <p class="form-help">Link active until {{ job.access_token_expires_at_human }}.</p>
                    {% elif share_link_ready %}
                      <p class="form-help">Link active with no expiration.</p>
                    {% elif job.access_token_expired %}
                      <p class="form-help">Token expired. Renew token to restore access.</p>
                    {% elif job.access_token_hint and not token_value %}
                      <p class="form-help">Token is hidden and ends in <span class="miscite-mono">{{ job.access_token_hint }}</span>. Rotate to reveal a new one.</p>
                    {% else %}
                      <p class="form-help">Rotate token to activate this link.</p>
                    {% endif %}
                    <details class="share-advanced-details" id="share-advanced-settings">
                      <summary>Advanced access settings</summary>
                      <div class="share-advanced-body">
                        {% if access_token_error %}
                          <div class="ds-alert ds-alert--error ds-mt-3">{{ access_token_error }}</div>
                        {% endif %}
                        <form method="post" action="/jobs/{{ job.id }}/access-token" class="ds-stack ds-stack--tight">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                          <div class="ds-input-row">
                            <div class="form-field">
                              <label class="form-label form-label--normal" for="access-token-expiry-mode">Expiration</label>
                              <select id="access-token-expiry-mode" name="expires_mode">
                                <option value="current" {% if job.access_token_expires_mode == "current" %}selected{% endif %}>
                                  Keep current
                                </option>
                                <option value="default" {% if job.access_token_expires_mode == "default" %}selected{% endif %}>
                                  Default ({{ access_token_days }} days)
                                </option>
                                <option value="date" {% if job.access_token_expires_mode == "date" %}selected{% endif %}>
                                  Specific date &amp; time (UTC)
                                </option>
                                <option value="never" {% if job.access_token_expires_mode == "never" %}selected{% endif %}>
                                  No expiration
                                </option>
                              </select>
                              <p class="form-help">Choose how long the token should remain valid.</p>
                            </div>
                            <div class="form-field" id="access-token-expires-at-field">
                              <label class="form-label form-label--normal" for="access-token-expires-at">Expires at (UTC)</label>
                              <input
                                id="access-token-expires-at"
                                name="expires_at"
                                type="datetime-local"
                                value="{{ job.access_token_expires_at_input }}"
                              />
                            </div>
                          </div>
                          <div class="ds-input-row">
                            <button
                              class="ds-button ds-button--secondary ds-button--sm"
                              type="submit"
                              name="action"
                              value="update-expiration"
                            >
                              Update expiration
                            </button>
                            <button
                              class="ds-button ds-button--ghost ds-button--sm"
                              type="submit"
                              name="action"
                              value="rotate"
                            >
                              {% if has_token %}
                                {% if job.access_token_expired %}
                                  Renew token
                                {% else %}
                                  Rotate token
                                {% endif %}
                              {% else %}
                                Generate token
                              {% endif %}
                            </button>
                          </div>
                        </form>
                        {% if job.access_token_hint and not token_value %}
                          <p class="form-help">Current hidden token ends in <span class="miscite-mono">{{ job.access_token_hint }}</span>.</p>
                        {% endif %}
                      </div>
                    </details>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          <div class="ds-card ds-card--subtle ds-card--danger">
            <div class="card-content">
              <details class="danger-zone-details">
                <summary>Danger zone</summary>
                <div class="danger-zone-body">
                  <p class="miscite-muted">Delete this report and uploaded file. This action cannot be undone.</p>
                  <form
                    method="post"
                    action="/jobs/{{ job.id }}/delete"
                    id="delete-report-form"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <button class="ds-button ds-button--warning ds-button--sm" type="submit">
                      Delete report
                    </button>
                  </form>
                </div>
              </details>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
    {% if job.error_message and not public_view %}
      <div class="ds-alert ds-alert--error ds-mt-5">
        {{ job.error_message }}
      </div>
    {% elif public_view and has_error %}
      <div class="ds-alert ds-alert--error ds-mt-5">
        This analysis encountered an error. Please ask the report owner to retry.
      </div>
    {% endif %}
  </section>

	  {% if job.status in ["PENDING", "RUNNING"] %}
	    <section class="ds-section" id="job-progress-section" data-job-id="{{ job.id }}">
	      <div class="ds-card">
	        <div class="card-content">
	          <div class="ds-progress-header">
	            <h3>Live progress</h3>
	            <div class="ds-progress-actions">
	              <span class="ds-pill" id="job-status-pill">{{ job.status }}</span>
	              {% if not public_view and job.status in ["PENDING", "RUNNING"] %}
	                <button
	                  class="ds-button ds-button--warning ds-button--sm"
	                  type="button"
	                  id="job-progress-stop"
	                  aria-label="Stop analysis"
	                >
                  Stop
                </button>
              {% endif %}
            </div>
          </div>
          <div class="ds-progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="2">
            <div class="ds-progress-fill" id="job-progress-fill" style="width: 2%"></div>
          </div>
          <p class="miscite-muted ds-mt-3" id="job-progress-text">Waiting for worker...</p>
          <p class="ds-progress-meta" id="job-progress-meta">Last update (UTC): --</p>
          <ul class="ds-progress-log" id="job-progress-log" aria-live="polite"></ul>
        </div>
      </div>
    </section>
	  {% endif %}
	
	    {% if report %}
	    {% set issues = report.issues|default([]) %}
	    {% set severity_counts = namespace(high=0, medium=0, low=0) %}
	    {% for issue in issues %}
	      {% set sev = issue.severity|default('medium')|lower %}
	      {% if sev == 'high' %}
	        {% set severity_counts.high = severity_counts.high + 1 %}
	      {% elif sev == 'low' %}
	        {% set severity_counts.low = severity_counts.low + 1 %}
	      {% else %}
	        {% set severity_counts.medium = severity_counts.medium + 1 %}
	      {% endif %}
	    {% endfor %}
	    {% set summary = report.summary or {} %}
      <div class="report-shell">
        <aside class="report-nav" aria-label="Report navigation">
          <div class="ds-card ds-card--subtle report-nav-card">
            <div class="card-content">
              <p class="eyebrow">Jump to</p>
              <nav class="report-nav-links">
                <a class="report-nav-link" href="#report-top">Overview</a>
                <a class="report-nav-link" href="#report-reviewers">Reviewers</a>
                <a class="report-nav-link" href="#report-summary">Summary</a>
                <a class="report-nav-link" href="#report-flags">Flags</a>
                {% if report.deep_analysis %}
                  <a class="report-nav-link" href="#report-recommendations">Recommendations</a>
                {% endif %}
                {% if report.deep_analysis and report.deep_analysis.status == "completed" and report.deep_analysis.references %}
                  <a class="report-nav-link" href="#report-reference-list">Reference list</a>
                {% endif %}
              </nav>
            </div>
          </div>
        </aside>
        <div class="report-body">
	    <section class="ds-section">
	      <div class="ds-grid">
	        <div class="span-12">
	          <div class="ds-card" id="report-summary">
	            <div class="card-content">
	              <h3>Summary</h3>
				              <div class="ds-stat-grid ds-stat-grid--cols">
		                <div class="ds-stat">
		                  <div class="ds-stat-value">{{ summary.total_intext_citations|default(0) }}</div>
		                  <div class="ds-stat-label">In-text citations</div>
		                </div>
		                <div class="ds-stat">
		                  <div class="ds-stat-value">{{ summary.total_citations|default(0) }}</div>
		                  <div class="ds-stat-label">References identified</div>
		                </div>
		                <div class="ds-stat">
		                  <div class="ds-stat-value">{{ summary.missing_bibliography_refs|default(0) }}</div>
		                  <div class="ds-stat-label">Missing refs</div>
		                </div>
		                <div class="ds-stat">
		                  <div class="ds-stat-value">{{ summary.ambiguous_bibliography_refs|default(0) }}</div>
		                  <div class="ds-stat-label">Ambiguous refs</div>
		                </div>
		                <div class="ds-stat">
		                  <div class="ds-stat-value">{{ summary.retracted_references|default(0) }}</div>
		                  <div class="ds-stat-label">Retractions</div>
		                </div>
		                <div class="ds-stat">
	                  <div class="ds-stat-value">{{ summary.predatory_matches|default(0) }}</div>
	                  <div class="ds-stat-label">Venue risk</div>
	                </div>
	                <div class="ds-stat">
	                  <div class="ds-stat-value">{{ summary.unresolved_references|default(0) }}</div>
	                  <div class="ds-stat-label">Unresolved</div>
	                </div>
	                <div class="ds-stat">
	                  <div class="ds-stat-value">{{ summary.potentially_inappropriate|default(0) }}</div>
	                  <div class="ds-stat-label">Potential issues</div>
	                </div>
	              </div>
            </div>
          </div>
	        </div>
	        <div class="span-12">
	          <div class="ds-card" id="report-flags">
		            <div class="card-content">
		              <h3>Flags</h3>
		              <p class="miscite-muted">Review issues by severity, with context and suggested next steps.</p>
	              {% if issues|length > 0 %}
	                <div class="ds-severity-grid ds-mt-4">
	                  <button
	                    type="button"
                    class="ds-severity-card ds-severity-card--high js-severity-filter"
                    data-severity-filter="high"
                    aria-pressed="false"
                    aria-label="Filter to high severity issues"
                  >
                    <div class="ds-severity-count">{{ severity_counts.high }}</div>
                    <div class="ds-severity-label">High severity</div>
                  </button>
                  <button
                    type="button"
                    class="ds-severity-card ds-severity-card--medium js-severity-filter"
                    data-severity-filter="medium"
                    aria-pressed="false"
                    aria-label="Filter to medium severity issues"
                  >
                    <div class="ds-severity-count">{{ severity_counts.medium }}</div>
                    <div class="ds-severity-label">Medium severity</div>
                  </button>
                  <button
                    type="button"
                    class="ds-severity-card ds-severity-card--low js-severity-filter"
                    data-severity-filter="low"
                    aria-pressed="false"
                    aria-label="Filter to low severity issues"
                  >
                    <div class="ds-severity-count">{{ severity_counts.low }}</div>
                    <div class="ds-severity-label">Low severity</div>
	                  </button>
	                </div>
	              {% endif %}
	              {% if issues|length == 0 %}
	                <div class="ds-empty">
	                  <h4>No issues flagged</h4>
	                  <p class="miscite-muted">This report did not surface any flagged citations.</p>
	                </div>
	              {% else %}
	                <div class="ds-disclosure-list">
	                  {% for issue in issues %}
	                    {% set raw_severity = issue.severity|default('medium')|lower %}
	                    {% set severity = raw_severity if raw_severity in ['high', 'medium', 'low'] else 'medium' %}
	                    {% set details = issue.details or {} %}
                    {% set citation = details.citation or {} %}
                    {% set resolution = details.resolution or {} %}
                    {% set issue_label = issue.type %}
	                    {% set issue_description = "" %}
	                    {% set issue_action = "" %}
	                    {% if issue.type == "missing_bibliography_ref" %}
	                      {% set issue_label = "Missing bibliography entry" %}
	                      {% set issue_description = "The in-text citation does not appear in the bibliography list." %}
	                      {% set issue_action = "Add a matching bibliography entry or correct the citation formatting." %}
	                    {% elif issue.type == "ambiguous_bibliography_ref" %}
	                      {% set issue_label = "Ambiguous bibliography match" %}
	                      {% set issue_description = "The in-text citation matched multiple bibliography entries with low confidence." %}
	                      {% set issue_action = "Disambiguate the citation or adjust bibliography entries so only one match remains." %}
	                    {% elif issue.type == "unresolved_reference" %}
	                      {% set issue_label = "Unresolved reference" %}
	                      {% set issue_description = "We found the bibliography entry but could not match it to metadata." %}
	                      {% set issue_action = "Verify DOI, title, author, or year in the bibliography entry." %}
                    {% elif issue.type == "retracted_article" %}
                      {% set issue_label = "Retracted work cited" %}
                      {% set issue_description = "This reference matches a retracted record." %}
                      {% set issue_action = "Consider replacing the reference or clearly noting the retraction context." %}
                    {% elif issue.type == "predatory_venue_match" %}
                      {% set issue_label = "Venue risk match" %}
                      {% set issue_description = "The journal or publisher matches a venue risk watchlist." %}
                      {% set issue_action = "Confirm the venue quality before citing." %}
                    {% elif issue.type == "potentially_inappropriate" %}
                      {% set issue_label = "Potentially inappropriate citation" %}
                      {% set issue_description = "The citation context appears misaligned with the cited work." %}
                      {% set issue_action = "Review the surrounding text and ensure relevance." %}
                    {% elif issue.type == "needs_manual_review" %}
                      {% set issue_label = "Needs manual review" %}
                      {% set issue_description = "Automated checks could not verify this citation." %}
                      {% set issue_action = "Review the citation manually for accuracy." %}
                    {% endif %}
                    <details
                      class="ds-disclosure ds-disclosure--{{ severity }} js-issue"
                      data-severity="{{ severity }}"
                    >
                      <summary class="ds-disclosure-summary">
                        <i class="material-icons ds-disclosure-icon" aria-hidden="true">flag</i>
                        <span class="ds-severity" aria-label="Severity {{ severity }}">{{ severity }}</span>
                        <span class="ds-disclosure-type">{{ issue_label }}</span>
                        <span class="ds-disclosure-title">{{ issue.title }}</span>
                        <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                      </summary>
                      <div class="ds-disclosure-body">
                        <div class="ds-issue-grid">
                          <div class="ds-issue-summary">
                            <h4>{{ issue_label }}</h4>
                            {% if issue_description %}
                              <p class="miscite-muted">{{ issue_description }}</p>
                            {% endif %}
                            {% if issue_action %}
                              <p class="ds-issue-guidance">{{ issue_action }}</p>
                            {% endif %}
                            <dl class="ds-meta">
                              {% if details.ref_id is defined %}
                                <dt>Reference ID</dt>
                                <dd class="miscite-mono">{{ details.ref_id }}</dd>
                              {% endif %}
                              {% if citation.raw %}
                                <dt>In-text citation</dt>
                                <dd class="miscite-mono">{{ citation.raw }}</dd>
                              {% endif %}
                              {% if citation.locator %}
                                <dt>Locator</dt>
                                <dd class="miscite-mono">{{ citation.locator }}</dd>
                              {% endif %}
                              {% if resolution.title %}
                                <dt>Title</dt>
                                <dd>{{ resolution.title }}</dd>
                              {% endif %}
                              {% if resolution.doi %}
                                <dt>DOI</dt>
                                <dd>
                                  <a
                                    class="miscite-mono"
                                    href="https://doi.org/{{ resolution.doi }}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                  >
                                    {{ resolution.doi }}
                                  </a>
                                </dd>
                              {% endif %}
                              {% if resolution.pmid %}
                                <dt>PMID</dt>
                                <dd>
                                  <a
                                    class="miscite-mono"
                                    href="https://pubmed.ncbi.nlm.nih.gov/{{ resolution.pmid }}/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                  >
                                    {{ resolution.pmid }}
                                  </a>
                                </dd>
                              {% endif %}
                              {% if resolution.pmcid %}
                                <dt>PMCID</dt>
                                <dd>
                                  <a
                                    class="miscite-mono"
                                    href="https://pmc.ncbi.nlm.nih.gov/articles/{{ resolution.pmcid }}/"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                  >
                                    {{ resolution.pmcid }}
                                  </a>
                                </dd>
                              {% endif %}
                              {% if resolution.arxiv_id %}
                                <dt>arXiv</dt>
                                <dd>
                                  <a
                                    class="miscite-mono"
                                    href="https://arxiv.org/abs/{{ resolution.arxiv_id }}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                  >
                                    {{ resolution.arxiv_id }}
                                  </a>
                                </dd>
                              {% endif %}
                              {% if resolution.journal %}
                                <dt>Journal</dt>
                                <dd>{{ resolution.journal }}</dd>
                              {% endif %}
                              {% if resolution.publisher %}
                                <dt>Publisher</dt>
                                <dd>{{ resolution.publisher }}</dd>
                              {% endif %}
                              {% if resolution.year %}
                                <dt>Year</dt>
                                <dd>{{ resolution.year }}</dd>
                              {% endif %}
                              {% if resolution.confidence is defined %}
                                <dt>Resolution confidence</dt>
                                <dd>{{ "%.2f"|format(resolution.confidence) }}</dd>
                              {% endif %}
                            </dl>
                            {% if details.retraction %}
                              <div class="ds-chip-row" aria-label="Retraction signals">
                                <span class="ds-chip">Retraction signal detected</span>
                                <span class="ds-chip">Verified registries</span>
                              </div>
                            {% endif %}
                            {% if details.match %}
                              <div class="ds-chip-row" aria-label="Venue risk signals">
                                <span class="ds-chip">Venue risk signal detected</span>
                                <span class="ds-chip">Curated watchlists</span>
                              </div>
                            {% endif %}
                            {% if details.nli %}
                              <div class="ds-chip-row" aria-label="Automated signals">
                                <span class="ds-chip">Automated signal: {{ details.nli.label }}</span>
                                <span class="ds-chip">Confidence: {{ "%.2f"|format(details.nli.confidence) }}</span>
                              </div>
                            {% elif details.llm %}
                              <div class="ds-chip-row" aria-label="Automated signals">
                                <span class="ds-chip">Automated signal: {{ details.llm.label }}</span>
                                <span class="ds-chip">Confidence: {{ "%.2f"|format(details.llm.confidence) }}</span>
                              </div>
                            {% endif %}
                          </div>
                          <div class="ds-issue-context">
                            <h4>Context</h4>
                            {% if citation.context %}
                              <p class="ds-quote">{{ citation.context }}</p>
                            {% else %}
                              <p class="miscite-muted">No context available for this citation.</p>
                            {% endif %}
                            {% if details.raw %}
                              <p class="ds-issue-caption">Bibliography entry</p>
                              <p class="ds-quote miscite-mono">{{ details.raw }}</p>
                            {% endif %}
                          </div>
                        </div>
                      </div>
                    </details>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </div>
	        </div>
	      </div>
	    </section>

		    {% if report.deep_analysis %}
		      <section class="ds-section" id="report-recommendations">
		        <div class="ds-card">
		          <div class="card-content">
		            <h3>Recommendations</h3>
	            <p class="miscite-muted">
	              Relevance analysis suggests additional references and improvement opportunities.
	              Use <span class="miscite-mono">[R#]</span> markers to jump to the full reference list below.
	            </p>

            {% if report.deep_analysis.status == "completed" %}
              {% set da = report.deep_analysis %}
              {% set rec = da.recommendations if da is mapping else None %}
              {% set da_ref_tooltips = da.references if da.references is mapping else {} %}

              {% if rec and rec.status == "completed" %}
                {% if rec.overview %}
                  <p class="miscite-muted">{{ rec.overview|da_cite(da_ref_tooltips) }}</p>
                {% endif %}
                {% if rec.note %}
                  <p class="miscite-muted">{{ rec.note }}</p>
                {% endif %}

	                {% set global_actions = rec.global_actions|default([]) %}
	                {% if global_actions %}
	                  <h4 class="ds-mt-4">Top priorities</h4>
	                  <ol class="ds-list ds-mt-3 ds-priority-list">
			                    {% for action in global_actions %}
			                      {% set action_rids = action.rids|default([]) %}
		                        {% set action_type = action.action_type|default("")|lower %}
		                        {% set action_type_label = action_type|replace("_", " ")|title %}
                        {% set action_chip_class = "ds-chip--action-strengthen" %}
                        {% if action_type == "add" %}
                          {% set action_chip_class = "ds-chip--action-add" %}
                        {% elif action_type == "justify" %}
                          {% set action_chip_class = "ds-chip--action-justify" %}
		                        {% elif action_type == "reconsider" %}
		                          {% set action_chip_class = "ds-chip--action-reconsider" %}
		                        {% endif %}
			                      <li class="ds-priority-item">
	                        {% set topic_action = action.action|default("") %}
	                        {% set location_text = action.where|default("", true) %}
	                        {% if not location_text %}
	                          {% set location_text = action.section_title|default("", true) %}
	                        {% endif %}
		                        <p class="ds-priority-title">
	                          <strong>Priority {{ loop.index }}: {{ topic_action }}{% if location_text %} - {{ location_text }}{% endif %}</strong>
		                        </p>
                          {% if action_type_label %}
                            <div class="ds-chip-row ds-priority-chip-row">
                              <span class="ds-chip {{ action_chip_class }}">{{ action_type_label }}</span>
                            </div>
                          {% endif %}
		                        {% if action.why %}
		                          <p class="miscite-muted ds-priority-body">{{ action.why|da_cite(da_ref_tooltips) }}</p>
		                        {% endif %}
	                        {% if action.anchor_quote %}
	                          <p class="ds-quote ds-priority-anchor">{{ action.anchor_quote }}</p>
	                        {% endif %}
	                        {% if action_rids %}
	                          <div class="ds-priority-supporting">
	                            <span class="miscite-muted">Supporting refs:</span>
	                            {% for raw_rid in action_rids %}
	                              {% set rid = raw_rid|replace("[", "")|replace("]", "")|trim %}
                              {% set ref_entry = da_ref_tooltips.get(rid) if da_ref_tooltips else None %}
                              {% set ref_tooltip = ref_entry|reference_hover_text if ref_entry is mapping else "" %}
                              <a class="miscite-mono" href="#da-ref-{{ rid }}"{% if ref_tooltip %} title="{{ ref_tooltip|replace('\n', ' ')|truncate(320, True)|e }}" aria-label="{{ ref_tooltip|replace('\n', ' ')|truncate(320, True)|e }}"{% endif %}>[{{ rid }}]</a>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                          </div>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ol>
                {% endif %}

                {% set section_recs = rec.sections|default([]) %}
                {% if section_recs %}
                  <h4 class="ds-mt-4">Other changes by section</h4>
                  <div class="ds-disclosure-list ds-mt-4">
                    {% for section in section_recs %}
                      {% set section_actions = section.actions|default([]) %}
                      <details class="ds-disclosure ds-disclosure--low">
                        <summary class="ds-disclosure-summary">
                          <i class="material-icons ds-disclosure-icon" aria-hidden="true">edit</i>
                          <span class="ds-disclosure-type">Section</span>
                          <span class="ds-disclosure-title">{{ section.title }}</span>
                          <span class="ds-severity">{{ section_actions|length }} actions</span>
                          <i class="material-icons ds-disclosure-caret" aria-hidden="true">expand_more</i>
                        </summary>
                        <div class="ds-disclosure-body">
                          {% if section_actions %}
                            <ol class="ds-list">
		                              {% for action in section_actions %}
		                                {% set action_rids = action.rids|default([]) %}
	                                  {% set action_type = action.action_type|default("")|lower %}
                                  {% set action_type_label = action_type|replace("_", " ")|title %}
                                  {% set action_chip_class = "ds-chip--action-strengthen" %}
                                  {% if action_type == "add" %}
                                    {% set action_chip_class = "ds-chip--action-add" %}
                                  {% elif action_type == "justify" %}
                                    {% set action_chip_class = "ds-chip--action-justify" %}
	                                  {% elif action_type == "reconsider" %}
	                                    {% set action_chip_class = "ds-chip--action-reconsider" %}
	                                  {% endif %}
		                                <li>
	                                  <p><strong>{{ action.action|default("")|da_cite(da_ref_tooltips) }}</strong></p>
                                      {% if action_type_label %}
                                        <div class="ds-chip-row ds-mt-3">
                                          <span class="ds-chip {{ action_chip_class }}">{{ action_type_label }}</span>
                                        </div>
                                      {% endif %}
	                                  {% if action.why %}
	                                    <p class="miscite-muted ds-mt-3">{{ action.why|da_cite(da_ref_tooltips) }}</p>
	                                  {% endif %}
                                  {% if action.where %}
                                    <p class="miscite-muted ds-mt-3"><span class="ds-source-name">Where:</span> {{ action.where }}</p>
                                  {% endif %}
                                  {% if action.anchor_quote %}
                                    <p class="ds-quote ds-mt-3">{{ action.anchor_quote }}</p>
                                  {% endif %}
                                  {% if action_rids %}
                                    <div class="ds-mt-3">
                                      <span class="miscite-muted">Supporting refs:</span>
                                      {% for raw_rid in action_rids %}
                                        {% set rid = raw_rid|replace("[", "")|replace("]", "")|trim %}
                                        {% set ref_entry = da_ref_tooltips.get(rid) if da_ref_tooltips else None %}
                                        {% set ref_tooltip = ref_entry|reference_hover_text if ref_entry is mapping else "" %}
                                        <a class="miscite-mono" href="#da-ref-{{ rid }}"{% if ref_tooltip %} title="{{ ref_tooltip|replace('\n', ' ')|truncate(320, True)|e }}" aria-label="{{ ref_tooltip|replace('\n', ' ')|truncate(320, True)|e }}"{% endif %}>[{{ rid }}]</a>{% if not loop.last %}, {% endif %}
                                      {% endfor %}
                                    </div>
                                  {% endif %}
                                </li>
                              {% endfor %}
                            </ol>
                          {% else %}
                            <p class="miscite-muted">No recommendations for this section.</p>
                          {% endif %}
                        </div>
                      </details>
                    {% endfor %}
                  </div>
                {% endif %}
              {% elif rec and rec.status == "skipped" %}
                <p class="miscite-muted">{{ rec.reason|default("No recommendations were generated for this run.") }}</p>
              {% else %}
                <p class="miscite-muted">No recommendations were generated for this run.</p>
              {% endif %}

		            {% elif report.deep_analysis.status == "skipped" %}
		              <p class="miscite-muted">{{ report.deep_analysis.reason|default("Recommendations were skipped.") }}</p>
	            {% else %}
	              <div class="ds-alert ds-alert--warning ds-mt-4">
                Recommendations did not complete: {{ report.deep_analysis.reason|default("Unknown error") }}
              </div>
            {% endif %}
          </div>
        </div>
      </section>
    {% endif %}


	    {% if report.deep_analysis and report.deep_analysis.status == "completed" and report.deep_analysis.references %}
	      {% set da = report.deep_analysis %}
	      <section class="ds-section" id="report-reference-list">
	        <div class="ds-card">
	          <div class="card-content">
	            <h3>Complete reference list</h3>
	            <p class="miscite-muted">
	              All deep-analysis references, alphabetized by author. Use the filter to show only references from a given group.
		            </p>
		            {% set all_refs = da.references.values()|list|sort(attribute='apa_base') %}
		            {% if da.citation_groups and all_refs|length > 0 %}
		              <div class="ds-input-row ds-mt-4">
		                <div class="form-field">
		                  <label class="form-label" for="da-ref-group-filter">Group filter</label>
		                  <select id="da-ref-group-filter" name="da_ref_group_filter">
		                    <option value="">All groups</option>
		                    {% for group in da.citation_groups %}
		                      {% set group_rids = group.rids|default([]) %}
		                      <option value="{{ loop.index0 }}" data-rids="{{ group_rids|join(',') }}">
		                        {{ group.title }} ({{ group_rids|length }})
		                      </option>
		                    {% endfor %}
		                  </select>
                  <p class="form-help">Groups are derived from deep-analysis reference categories.</p>
		                </div>
		              </div>
		              <p class="miscite-muted ds-mt-3" id="da-ref-count" aria-live="polite"></p>
		            {% endif %}
	            <ol class="ds-list ds-mt-3">
		              {% for ref in all_refs %}
		                <li id="da-ref-{{ ref.rid }}" data-da-rid="{{ ref.rid }}">
                      <div>
                        <span class="miscite-mono">[{{ ref.rid }}]</span>
                        {{ ref.apa_base }}
                      </div>
                      {% set ref_sources = ref|reference_sources %}
                      {% if ref_sources %}
                        <div class="miscite-muted ds-mt-3">
                          Source{% if ref_sources|length > 1 %}s{% endif %}: {{ ref_sources|join(" Â· ") }}
                        </div>
                      {% endif %}
                      <div class="ds-chip-row ds-mt-3" aria-label="Reference links">
	                    {% if ref.doi %}
	                      <a class="ds-chip miscite-mono" href="https://doi.org/{{ ref.doi }}" target="_blank" rel="noopener noreferrer">
	                        DOI: {{ ref.doi }}
	                      </a>
	                    {% endif %}
	                    {% if not ref.doi %}
	                      {% set safe_url = ref.official_url|safe_url %}
	                      {% if safe_url %}
	                        <a class="ds-chip miscite-mono" href="{{ safe_url }}" target="_blank" rel="noopener noreferrer">
	                          URL: {{ safe_url }}
	                        </a>
	                      {% endif %}
	                    {% endif %}
	                    {% set safe_pdf = ref.oa_pdf_url|safe_url %}
	                    {% if safe_pdf %}
	                      <a class="ds-chip" href="{{ safe_pdf }}" target="_blank" rel="noopener noreferrer">
	                        Open PDF
	                      </a>
	                    {% endif %}
	                  </div>
	                  {% if ref.in_paper %}
	                    <div class="ds-chip-row ds-mt-3" aria-label="Reference status">
	                      <span class="ds-chip ds-chip--success">Already cited</span>
	                    </div>
                  {% endif %}
                </li>
              {% endfor %}
            </ol>
	          </div>
	        </div>
	      </section>
	    {% endif %}

        </div>
      </div>
	  {% else %}
	    {% if job.status == "COMPLETED" %}
	      <section class="ds-section">
	        <div class="ds-empty">
	          <h4>Report not available yet</h4>
	          <p class="miscite-muted">Refresh in a moment to view the generated summary.</p>
	          {% if public_view %}
	            <a class="ds-button ds-button--secondary" href="{{ request.url.path }}">Refresh report</a>
	          {% else %}
	            <a class="ds-button ds-button--secondary" href="/jobs/{{ job.id }}">Refresh report</a>
	          {% endif %}
	        </div>
	      </section>
	    {% elif job.status in ["FAILED", "CANCELED"] %}
	      <section class="ds-section">
	        <div class="ds-empty">
	          <h4>Report unavailable</h4>
	          <p class="miscite-muted">This analysis did not produce a report.</p>
	        </div>
	      </section>
	    {% endif %}
	  {% endif %}
  <script nonce="{{ csp_nonce }}">
    (function () {
      var section = document.getElementById("job-progress-section");
      if (!section) {
        return;
      }

      var publicView = {{ "true" if public_view else "false" }};
      var accessToken = null;
      if (publicView) {
        var match = window.location.pathname.match(/^\/reports\/([^/]+)$/);
        if (match) {
          accessToken = decodeURIComponent(match[1]);
        }
        if (!accessToken) {
          return;
        }
      }

      var jobId = section.getAttribute("data-job-id");
      var statusText = document.getElementById("job-status-text");
      var statusPill = document.getElementById("job-status-pill");
      var progressFill = document.getElementById("job-progress-fill");
      var progressText = document.getElementById("job-progress-text");
      var progressMeta = document.getElementById("job-progress-meta");
      var progressLog = document.getElementById("job-progress-log");
      var stopButton = document.getElementById("job-progress-stop");
      var csrfToken = "{{ csrf_token }}";

      var lastEventId = 0;
      var lastProgress = 2;
      var terminal = { COMPLETED: true, FAILED: true, CANCELED: true };

      var setStatus = function (status) {
        var value = status || "UNKNOWN";
        if (statusText) {
          statusText.textContent = value;
        }
        if (statusPill) {
          statusPill.textContent = value;
        }
        if (stopButton) {
          var canStop = value === "PENDING" || value === "RUNNING";
          stopButton.disabled = !canStop;
          stopButton.style.display = canStop ? "" : "none";
        }
      };

      var formatTime = function (iso) {
        var date = iso ? new Date(iso) : new Date();
        if (isNaN(date.getTime())) {
          date = new Date();
        }
        var y = date.getUTCFullYear();
        var m = String(date.getUTCMonth() + 1).padStart(2, "0");
        var d = String(date.getUTCDate()).padStart(2, "0");
        var hh = String(date.getUTCHours()).padStart(2, "0");
        var mm = String(date.getUTCMinutes()).padStart(2, "0");
        var ss = String(date.getUTCSeconds()).padStart(2, "0");
        return y + "-" + m + "-" + d + " " + hh + ":" + mm + ":" + ss + " UTC";
      };

      var formatStage = function (stage) {
        if (!stage) {
          return "";
        }
        var cleaned = String(stage).replace(/_/g, " ").trim();
        if (!cleaned) {
          return "";
        }
        return cleaned.charAt(0).toUpperCase() + cleaned.slice(1);
      };

      var formatPercent = function (progress) {
        if (typeof progress !== "number") {
          return "";
        }
        return String(Math.round(progress * 100)) + "%";
      };

      var setProgress = function (progress, message, stage, createdAt) {
        if (typeof progress === "number") {
          var pct = Math.max(2, Math.min(100, Math.round(progress * 100)));
          if (pct >= lastProgress) {
            lastProgress = pct;
            if (progressFill && progressFill.parentElement) {
              progressFill.style.width = pct + "%";
              progressFill.parentElement.setAttribute("aria-valuenow", String(pct));
            }
          }
        }
        if (progressText) {
          var stageLabel = formatStage(stage);
          var pctLabel = formatPercent(progress);
          var parts = [];
          if (stageLabel) {
            parts.push(stageLabel);
          }
          if (message) {
            parts.push(message);
          }
          if (pctLabel) {
            parts.push(pctLabel);
          }
          progressText.textContent = parts.length ? parts.join(" \u2022 ") : "Working...";
        }
        if (progressMeta) {
          progressMeta.textContent = "Last update: " + formatTime(createdAt);
        }
      };

      var appendLog = function (payload) {
        if (!progressLog || !payload) {
          return;
        }
        var stageLabel = formatStage(payload.stage);
        var message = payload.message ? String(payload.message).trim() : "";
        var detail = "";
        if (stageLabel && message) {
          detail = stageLabel + " \u2014 " + message;
        } else {
          detail = message || stageLabel || "Update";
        }
        var pctLabel = formatPercent(payload.progress);
        var timeLabel = formatTime(payload.created_at);
        var item = document.createElement("li");
        item.className = "ds-progress-item";
        var time = document.createElement("span");
        time.className = "ds-progress-time";
        time.textContent = timeLabel;
        if (payload.created_at) {
          time.title = payload.created_at;
        }
        var text = document.createElement("span");
        text.className = "ds-progress-detail";
        text.textContent = detail;
        item.appendChild(time);
        item.appendChild(text);
        if (pctLabel) {
          var pct = document.createElement("span");
          pct.className = "ds-progress-percent";
          pct.textContent = pctLabel;
          item.appendChild(pct);
        }
        progressLog.prepend(item);
        var maxItems = 10;
        while (progressLog.children.length > maxItems) {
          progressLog.removeChild(progressLog.lastChild);
        }
      };

      var handleDone = function (status) {
        if (status === "FAILED") {
          setProgress(1.0, "Job failed.", "failed");
          return;
        }
        if (status === "CANCELED") {
          setProgress(1.0, "Job canceled.", "canceled");
          return;
        }
        setProgress(1.0, "Analysis complete. Refreshing...", "complete");
        setTimeout(function () {
          window.location.reload();
        }, 1200);
      };

      var handleProgress = function (payload) {
        if (!payload) {
          return;
        }
        if (payload.id && payload.id > lastEventId) {
          lastEventId = payload.id;
        }
        setProgress(payload.progress, payload.message, payload.stage, payload.created_at);
        appendLog(payload);
      };

      var handleStatus = function (payload) {
        if (!payload) {
          return;
        }
        setStatus(payload.status);
        if (terminal[payload.status || ""]) {
          handleDone(payload.status);
        }
      };

      var requestCancel = function () {
        if (!stopButton) {
          return;
        }
        stopButton.disabled = true;
        stopButton.textContent = "Stopping...";
        setProgress(lastProgress / 100, "Canceling...", "canceled", new Date().toISOString());
        fetch("/api/jobs/" + jobId + "/cancel", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Accept: "application/json",
          },
          credentials: "same-origin",
          body: "csrf_token=" + encodeURIComponent(csrfToken || ""),
        })
          .then(function (resp) {
            if (!resp.ok) {
              throw new Error("Cancel request failed");
            }
            return resp.json();
          })
          .then(function (data) {
            var status = (data && data.status) || "CANCELED";
            setStatus(status);
            if (terminal[status]) {
              handleDone(status);
            }
          })
          .catch(function () {
            if (stopButton) {
              stopButton.disabled = false;
              stopButton.textContent = "Stop";
            }
          });
      };

      if (stopButton) {
        stopButton.addEventListener("click", function () {
          if (!confirm("Stop this analysis?")) {
            return;
          }
          requestCancel();
        });
      }

      var eventsPath = publicView ? "/api/reports/" + accessToken + "/events" : "/api/jobs/" + jobId + "/events";
      var streamUrl = publicView ? "/api/reports/" + accessToken + "/stream" : "/api/jobs/" + jobId + "/stream";

      var poll = function () {
        fetch(eventsPath + "?since_id=" + lastEventId, {
          headers: { Accept: "application/json" },
          cache: "no-store",
        })
          .then(function (resp) {
            return resp.ok ? resp.json() : null;
          })
          .then(function (data) {
            if (!data) {
              return;
            }
            if (Array.isArray(data.events)) {
              data.events.forEach(handleProgress);
            }
            handleStatus(data);
          })
          .catch(function () {
            // ignore polling errors
          });
      };

      var connect = function () {
        if (!window.EventSource) {
          setInterval(poll, 2000);
          poll();
          return;
        }
        var source = new EventSource(streamUrl);
        source.addEventListener("progress", function (event) {
          try {
            handleProgress(JSON.parse(event.data));
          } catch (err) {
            // ignore parse errors
          }
        });
        source.addEventListener("status", function (event) {
          try {
            handleStatus(JSON.parse(event.data));
          } catch (err) {
            // ignore parse errors
          }
        });
        source.addEventListener("done", function (event) {
          try {
            handleDone(JSON.parse(event.data).status);
          } catch (err) {
            handleDone("COMPLETED");
          }
          source.close();
        });
        source.onerror = function () {
          source.close();
          setInterval(poll, 2000);
          poll();
        };
      };

      connect();
    })();
  </script>
  <script nonce="{{ csp_nonce }}">
    (function () {
      var buttons = document.querySelectorAll("[data-severity-filter]");
      if (!buttons.length) {
        return;
      }
      var issues = document.querySelectorAll(".js-issue[data-severity]");
      var active = null;

      var setActive = function (severity) {
        active = severity;
        buttons.forEach(function (btn) {
          var isActive = btn.getAttribute("data-severity-filter") === severity;
          btn.classList.toggle("is-active", isActive);
          btn.setAttribute("aria-pressed", isActive ? "true" : "false");
        });
        issues.forEach(function (issue) {
          var match = issue.getAttribute("data-severity") === severity;
          issue.hidden = !match;
        });
      };

      var clearActive = function () {
        active = null;
        buttons.forEach(function (btn) {
          btn.classList.remove("is-active");
          btn.setAttribute("aria-pressed", "false");
        });
        issues.forEach(function (issue) {
          issue.hidden = false;
        });
      };

      buttons.forEach(function (btn) {
        btn.addEventListener("click", function (event) {
          event.stopPropagation();
          var severity = btn.getAttribute("data-severity-filter");
          if (!severity) {
            return;
          }
          if (active === severity) {
            clearActive();
          } else {
            setActive(severity);
          }
        });
      });

      document.addEventListener("click", function (event) {
        if (!active) {
          return;
        }
        if (event.target.closest("[data-severity-filter]")) {
          return;
        }
        clearActive();
      });
    })();
  </script>
  <script nonce="{{ csp_nonce }}">
    (function () {
      var select = document.getElementById("da-ref-group-filter");
      if (!select) {
        return;
      }
      var items = Array.prototype.slice.call(document.querySelectorAll("li[data-da-rid]"));
      if (!items.length) {
        return;
      }
      var count = document.getElementById("da-ref-count");
      var total = items.length;

      var updateCount = function (shown) {
        if (!count) {
          return;
        }
        count.textContent = "Showing " + String(shown) + " of " + String(total) + " references.";
      };

      var apply = function () {
        var option = select.options[select.selectedIndex];
        var raw = option ? option.getAttribute("data-rids") : "";
        var filter = null;
        if (raw && raw.trim()) {
          filter = new Set(
            raw
              .split(",")
              .map(function (rid) {
                return (rid || "").trim();
              })
              .filter(Boolean)
          );
        }
        var shown = 0;
        items.forEach(function (item) {
          var rid = item.getAttribute("data-da-rid") || "";
          var visible = !filter || filter.has(rid);
          item.hidden = !visible;
          if (visible) {
            shown += 1;
          }
        });
        updateCount(shown);
      };

      select.addEventListener("change", apply);
      apply();
    })();
  </script>
  <script nonce="{{ csp_nonce }}">
    (function () {
      var links = Array.prototype.slice.call(document.querySelectorAll(".report-nav-link[href^='#']"));
      if (!links.length) {
        return;
      }

      var sections = links
        .map(function (link) {
          var href = link.getAttribute("href") || "";
          var id = href.charAt(0) === "#" ? href.slice(1) : "";
          if (!id) return null;
          var section = document.getElementById(id);
          if (!section) return null;
          return { id: id, link: link, section: section };
        })
        .filter(Boolean);

      if (!sections.length) {
        return;
      }

      var setCurrent = function (id) {
        sections.forEach(function (item) {
          if (item.id === id) {
            item.link.setAttribute("aria-current", "location");
          } else {
            item.link.removeAttribute("aria-current");
          }
        });
      };

      var computeCurrent = function () {
        var offset = 120;
        var current = sections[0].id;
        sections.forEach(function (item) {
          var top = item.section.getBoundingClientRect().top;
          if (top <= offset) {
            current = item.id;
          }
        });
        setCurrent(current);
      };

      var ticking = false;
      var onScroll = function () {
        if (ticking) return;
        ticking = true;
        window.requestAnimationFrame(function () {
          computeCurrent();
          ticking = false;
        });
      };

      window.addEventListener("scroll", onScroll, { passive: true });
      window.addEventListener("resize", onScroll);
      window.addEventListener("hashchange", computeCurrent);
      computeCurrent();
    })();
  </script>
  <script nonce="{{ csp_nonce }}">
    (function () {
      var publicView = {{ "true" if public_view else "false" }};
      if (publicView) {
        return;
      }

      var jobId = "{{ job.id }}";
      var csrfToken = "{{ csrf_token }}";
      var inlineStatus = document.getElementById("share-inline-status");
      var toast = document.getElementById("share-toast");
      var openLink = document.getElementById("share-link-open");
      var toggleForm = document.getElementById("sharing-toggle-form");
      var toggleButton = document.getElementById("sharing-toggle-button");
      var deleteForm = document.getElementById("delete-report-form");
      var advancedSettings = document.getElementById("share-advanced-settings");
      var shareViewLoadedAt = Date.now();
      var tracked = {
        copied: false,
        opened: false,
        advancedOpened: false,
      };
      var toastTimer = 0;

      var setFeedback = function (message, tone) {
        if (!message) {
          return;
        }
        var level = tone || "info";
        if (inlineStatus) {
          inlineStatus.textContent = message;
          inlineStatus.setAttribute("data-tone", level);
        }
        if (!toast) {
          return;
        }
        if (toastTimer) {
          window.clearTimeout(toastTimer);
        }
        toast.hidden = false;
        toast.textContent = message;
        toast.setAttribute("data-tone", level);
        toast.classList.add("is-visible");
        toastTimer = window.setTimeout(function () {
          toast.classList.remove("is-visible");
          window.setTimeout(function () {
            toast.hidden = true;
          }, 180);
        }, 1200);
      };

      var metricBody = function (name, value) {
        var params = new URLSearchParams();
        params.append("csrf_token", csrfToken || "");
        params.append("name", name || "");
        if (typeof value === "string" && value) {
          params.append("value", value);
        }
        return params.toString();
      };

      var sendMetric = function (name, value, options) {
        if (!jobId || !csrfToken || !name) {
          return;
        }
        var body = metricBody(name, value);
        var path = "/api/jobs/" + encodeURIComponent(jobId) + "/ui-metric";
        var useBeacon = !!(options && options.keepalive && navigator.sendBeacon);
        if (useBeacon) {
          try {
            var blob = new Blob([body], { type: "application/x-www-form-urlencoded" });
            if (navigator.sendBeacon(path, blob)) {
              return;
            }
          } catch (err) {
            // fallback to fetch below
          }
        }
        fetch(path, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Accept: "application/json",
          },
          credentials: "same-origin",
          keepalive: !!(options && options.keepalive),
          body: body,
        }).catch(function () {
          // ignore metric submission errors
        });
      };

      window.addEventListener("miscite:copy", function (event) {
        var detail = (event && event.detail) || {};
        if ((detail.targetId || "") !== "access-link-value") {
          return;
        }
        if (detail.ok === false) {
          setFeedback("Could not copy the share link.", "error");
          return;
        }
        setFeedback("Share link copied.", "success");
        if (!tracked.copied) {
          tracked.copied = true;
          sendMetric("share_link_copy_ms", String(Math.max(0, Date.now() - shareViewLoadedAt)));
        }
      });

      if (openLink) {
        openLink.addEventListener("click", function () {
          if (openLink.getAttribute("aria-disabled") === "true") {
            return;
          }
          setFeedback("Opening shared report in a new tab.", "info");
          if (!tracked.opened) {
            tracked.opened = true;
            sendMetric("share_link_open_ms", String(Math.max(0, Date.now() - shareViewLoadedAt)));
          }
        });
      }

      if (advancedSettings) {
        var trackAdvancedOpen = function () {
          if (advancedSettings.open && !tracked.advancedOpened) {
            tracked.advancedOpened = true;
            sendMetric("share_advanced_opened", "1");
          }
        };
        advancedSettings.addEventListener("toggle", trackAdvancedOpen);
        trackAdvancedOpen();
      }

      if (toggleForm && toggleButton) {
        toggleForm.addEventListener("submit", function (event) {
          var action = (toggleButton.value || "").toLowerCase();
          if (action !== "disable") {
            sendMetric("share_toggle_on", "1", { keepalive: true });
            setFeedback("Turning sharing on...", "success");
            return;
          }
          if (!window.confirm("Turn off sharing? Existing share links will stop working until you turn sharing on again.")) {
            event.preventDefault();
            setFeedback("Sharing stays on.", "info");
            sendMetric("share_disable_misclick", "1");
            return;
          }
          sendMetric("share_toggle_off", "1", { keepalive: true });
          setFeedback("Turning sharing off...", "warning");
        });
      }

      if (deleteForm) {
        deleteForm.addEventListener("submit", function (event) {
          if (!window.confirm("Delete this report and uploaded file? This cannot be undone.")) {
            event.preventDefault();
            setFeedback("Delete canceled.", "info");
            sendMetric("delete_report_misclick", "1");
            return;
          }
          sendMetric("delete_report_confirmed", "1", { keepalive: true });
          setFeedback("Deleting report...", "warning");
        });
      }

      var params = new URLSearchParams(window.location.search || "");
      var sharingState = params.get("sharing");
      if (sharingState === "disabled") {
        setFeedback("Sharing disabled. The report is now protected.", "warning");
      } else if (sharingState === "enabled") {
        setFeedback("Sharing enabled.", "success");
      }
      if (sharingState && window.history && window.history.replaceState) {
        params.delete("sharing");
        var nextQuery = params.toString();
        var nextUrl = window.location.pathname + (nextQuery ? "?" + nextQuery : "") + window.location.hash;
        window.history.replaceState({}, document.title, nextUrl);
      }
    })();
  </script>
  <script nonce="{{ csp_nonce }}">
    (function () {
      var mode = document.getElementById("access-token-expiry-mode");
      var expiresField = document.getElementById("access-token-expires-at-field");
      var expiresInput = document.getElementById("access-token-expires-at");
      if (!mode || !expiresField || !expiresInput) {
        return;
      }

      var sync = function () {
        var isDate = mode.value === "date";
        expiresField.style.display = isDate ? "" : "none";
        expiresInput.disabled = !isDate;
      };

      mode.addEventListener("change", sync);
      sync();
    })();
  </script>
{% endblock %}
