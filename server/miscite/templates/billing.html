{% extends "base.html" %}
{% block content %}
  <section class="ds-section">
    <div class="ds-grid">
      <div class="span-7">
        <p class="eyebrow">Billing</p>
        <h1>Balance & usage</h1>
        <p class="lead">Pay as you go with balance top-ups (optional auto-charge when your balance runs low).</p>
      </div>
      <div class="span-5">
        <div class="ds-card ds-card--subtle">
          <div class="card-content">
            <h3>Current balance</h3>
            <p class="miscite-muted">Available credit for new analyses.</p>
            <div class="ds-alert ds-alert--info">
              <span class="miscite-mono">{{ balance_display }}</span>
            </div>
            {% if auto_charge_enabled %}
              <p class="form-help">Auto-charge on • Triggers below {{ auto_charge_threshold_display }}.</p>
            {% else %}
              <p class="form-help">Auto-charge is off.</p>
            {% endif %}
            {% if auto_charge_last_error %}
              <div class="ds-alert ds-alert--warning ds-mt-3">{{ auto_charge_last_error }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </section>

  {% if not billing_enabled %}
    <section class="ds-section">
      <div class="ds-alert ds-alert--info">
        Billing is disabled in this environment.
      </div>
    </section>
  {% else %}
    {% if billing_error %}
      <section class="ds-section">
        <div class="ds-alert ds-alert--error">{{ billing_error }}</div>
      </section>
    {% endif %}
    {% if billing_success %}
      <section class="ds-section">
        <div class="ds-alert ds-alert--success">{{ billing_success }}</div>
      </section>
    {% endif %}
    <section class="ds-section">
      <div class="ds-card ds-card--subtle">
        <div class="card-content">
          <h3>Billing setup</h3>
          <p class="miscite-muted">Start with pay as you go (top up when you need). Auto-charge is optional.</p>
          <ol class="ds-stepper">
            <li class="ds-stepper-step {{ 'is-complete' if stripe_ready else 'is-active' }}">
              <span class="ds-stepper-bullet"></span>
              Configure Stripe
            </li>
            <li class="ds-stepper-step {{ 'is-complete' if balance_cents > 0 else ('is-active' if stripe_ready else '') }}">
              <span class="ds-stepper-bullet"></span>
              Pay as you go (add funds)
            </li>
            <li class="ds-stepper-step {{ 'is-complete' if auto_charge_enabled else ('is-active' if stripe_ready and has_payment_method else '') }}">
              <span class="ds-stepper-bullet"></span>
              Optional: enable auto-charge
            </li>
          </ol>

          {% if not stripe_configured %}
            <div class="ds-alert ds-alert--warning ds-mt-3">
              Stripe isn’t configured on this deployment yet.
            </div>
          {% elif not stripe_webhook_configured %}
            <div class="ds-alert ds-alert--warning ds-mt-3">
              Stripe webhooks aren’t configured, so top-ups and auto-charge can’t be credited.
            </div>
            {% if is_local_dev %}
              <p class="form-help ds-mt-2">
                Dev tip: run <span class="miscite-mono">stripe listen --forward-to {{ public_origin }}/billing/webhook</span>
                and set <span class="miscite-mono">STRIPE_WEBHOOK_SECRET</span>.
              </p>
            {% endif %}
          {% elif balance_cents <= 0 %}
            <div class="ds-alert ds-alert--info ds-mt-3">
              Next: top up your balance (pay as you go).
            </div>
          {% elif not auto_charge_enabled and not (billing_profile_ready and has_payment_method) %}
            <div class="ds-alert ds-alert--info ds-mt-3">
              Optional: add a payment method so you can enable auto-charge.
            </div>
          {% elif not auto_charge_enabled %}
            <div class="ds-alert ds-alert--info ds-mt-3">
              Optional: enable auto-charge and choose a trigger + recharge amount.
            </div>
          {% endif %}

          {% if stripe_ready %}
            <a class="ds-button ds-button--primary ds-mt-3" href="#add-funds">Pay as you go: add funds</a>
          {% endif %}
          {% if stripe_ready and can_open_portal %}
            <form method="post" action="/billing/portal" class="ds-mt-2">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button class="ds-button ds-button--secondary" type="submit">Add / manage payment method</button>
            </form>
          {% endif %}
          <a class="ds-button ds-button--ghost ds-mt-2" href="#auto-charge">Auto-charge (optional)</a>
        </div>
      </div>
    </section>

    <section class="ds-section" id="add-funds">
      <div class="ds-grid">
        <div class="span-6">
          <div class="ds-card">
            <div class="card-content">
              <h3>Pay as you go</h3>
              <p class="miscite-muted">Top up your balance when you need to run checks. Minimum {{ min_charge_display }}.</p>
              <form method="post" action="/billing/topup" class="ds-stack ds-stack--tight">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <div class="form-field">
                  <label class="form-label" for="topup-amount">Top-up amount (USD)</label>
                  <input
                    id="topup-amount"
                    name="amount"
                    type="number"
                    inputmode="decimal"
                    min="{{ min_charge_cents / 100 }}"
                    step="0.01"
                    placeholder="25.00"
                    required
                    {{ "disabled" if not stripe_ready else "" }}
                  />
                  <p class="form-help">You will be redirected to Stripe to complete payment.</p>
                </div>
                <button class="ds-button ds-button--primary" type="submit" {{ "disabled" if not stripe_ready else "" }}>Add funds</button>
              </form>
            </div>
          </div>
        </div>
        <div class="span-6">
          <div class="ds-card">
            <div class="card-content">
              <h3 id="auto-charge">Auto-charge</h3>
              <p class="miscite-muted">Automatically recharge when your balance dips below a threshold.</p>
              <p class="form-help">Requires a saved payment method. Auto-charge runs after a billed analysis; it won’t charge immediately just by enabling.</p>
              {% if auto_charge_success %}
                <div class="ds-alert ds-alert--success ds-mt-3">{{ auto_charge_success }}</div>
              {% endif %}
              {% if auto_charge_error %}
                <div class="ds-alert ds-alert--warning ds-mt-3">{{ auto_charge_error }}</div>
              {% endif %}
              <form method="post" action="/billing/auto-charge" class="ds-stack ds-stack--tight">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                <label class="ds-toggle">
                  <input type="checkbox" name="enabled" value="true" {{ "checked" if auto_charge_enabled else "" }} />
                  <span>Enable auto-charge</span>
                </label>
                <div class="ds-input-row">
                  <div class="form-field">
                    <label class="form-label" for="auto-charge-threshold">Trigger balance (USD)</label>
                    <input
                      id="auto-charge-threshold"
                      name="threshold"
                      type="number"
                      inputmode="decimal"
                      min="0.01"
                      step="0.01"
                      value="{{ auto_charge_threshold_value }}"
                      required
                    />
                  </div>
                  <div class="form-field">
                    <label class="form-label" for="auto-charge-amount">Recharge amount (USD)</label>
                    <input
                      id="auto-charge-amount"
                      name="amount"
                      type="number"
                      inputmode="decimal"
                      min="{{ min_charge_cents / 100 }}"
                      step="0.01"
                      value="{{ auto_charge_amount_value }}"
                      required
                    />
                  </div>
                </div>
                <button class="ds-button ds-button--secondary" type="submit">Save auto-charge</button>
              </form>
              {% if can_open_portal %}
                <form method="post" action="/billing/portal" class="ds-mt-4">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <button class="ds-button ds-button--ghost" type="submit">Add / manage payment method</button>
                </form>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="ds-section">
      <div class="ds-card">
        <div class="card-content">
          <h3>Recent activity</h3>
          {% if transactions|length == 0 %}
            <p class="miscite-muted">No billing activity yet.</p>
          {% else %}
            <div class="ds-table-wrap" role="region" aria-label="Recent billing activity" tabindex="0">
              <table class="ds-table">
                <thead>
                  <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Type</th>
                    <th scope="col">Amount</th>
                    <th scope="col">Balance after</th>
                  </tr>
                </thead>
                <tbody>
                  {% for txn in transactions %}
                    <tr>
                      <td>{{ txn.created_at_human }}</td>
                      <td class="miscite-mono">{{ txn.kind }}</td>
                      <td class="miscite-mono">{{ txn.amount_display }}</td>
                      <td class="miscite-mono">{{ txn.balance_after_display }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}
        </div>
      </div>
    </section>
  {% endif %}
{% endblock %}
