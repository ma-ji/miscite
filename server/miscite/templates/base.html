<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    {% set page_title = (title or "miscite")|trim %}
    {% if page_title|lower in ["miscite", ""] %}
      {% set full_title = "miscite — Real & Relevant Citations" %}
    {% else %}
      {% set full_title = page_title ~ " · miscite" %}
    {% endif %}
    <title>{{ full_title }}</title>
    <meta name="description" content="{{ meta_description }}" />
    <meta name="keywords" content="{{ meta_keywords }}" />
    <meta name="author" content="miscite" />
    <meta name="robots" content="{{ robots }}" />
    <meta name="googlebot" content="{{ robots }}" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <link rel="canonical" href="{{ canonical_url }}" />
    <link rel="alternate" hreflang="en-US" href="{{ canonical_url }}" />
    <meta property="og:site_name" content="miscite" />
    <meta property="og:type" content="{{ og_type|default('website') }}" />
    <meta property="og:url" content="{{ canonical_url }}" />
    <meta property="og:title" content="{{ full_title }}" />
    <meta property="og:description" content="{{ meta_description }}" />
    <meta property="og:image" content="{{ og_image_url }}" />
    <meta property="og:image:alt" content="{{ og_image_alt }}" />
    <meta property="og:image:type" content="image/svg+xml" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content="en_US" />
    <meta name="twitter:card" content="{{ twitter_card|default('summary') }}" />
    <meta name="twitter:url" content="{{ canonical_url }}" />
    <meta name="twitter:title" content="{{ full_title }}" />
    <meta name="twitter:description" content="{{ meta_description }}" />
    <meta name="twitter:image" content="{{ og_image_url }}" />
    <meta name="twitter:image:alt" content="{{ og_image_alt }}" />
    <meta name="application-name" content="miscite" />
    <meta name="theme-color" content="#990000" />
    <link rel="icon" href="/static/favicon.svg" type="image/svg+xml" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap" />
    <meta name="color-scheme" content="light dark" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link rel="stylesheet" href="/static/styles.css" />
    {% block head %}{% endblock %}
    
    <script nonce="{{ csp_nonce }}" charset="UTF-8" id="LA_COLLECT" src="https://sdk.51.la/js-sdk-pro.min.js"></script>
    <script nonce="{{ csp_nonce }}">LA.init({id:"L5Omf1RQEJylPFT1",ck:"L5Omf1RQEJylPFT1",autoTrack:true,hashMode:true,screenRecord:true})</script>
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to content</a>
    <header class="app-header">
      <div class="ds-container app-header-inner">
        {% set path = request.url.path %}
        {% set on_reports_access = path.startswith("/reports") %}
        <div class="app-brand">
          <a href="/" class="app-logo miscite-wordmark" aria-label="miscite home">miscite</a>
          <span class="app-tag">Real & Relevant Citations</span>
        </div>
        <nav class="app-nav" aria-label="Primary">
          {% if current_user %}
            {% set on_dashboard = path == "/dashboard" or path.startswith("/jobs") %}
            {% set on_billing = path.startswith("/billing") %}
            <a class="app-nav-link" href="/dashboard" {{ "aria-current=page" if on_dashboard else "" }}>
              Dashboard
            </a>
            <a class="app-nav-link" href="/billing" {{ "aria-current=page" if on_billing else "" }}>
              Billing
            </a>
          {% else %}
            <a class="app-nav-link" href="/#features">Features</a>
            <a class="app-nav-link" href="/#workflow">Workflow</a>
            <a class="app-nav-link" href="/#trust">Trust</a>
          {% endif %}
        </nav>
        <div class="app-actions">
          {% if not hide_report_access %}
            <a
              class="ds-button ds-button--ghost ds-button--sm app-report-button"
              href="/reports/access"
              {{ "aria-current=page" if on_reports_access else "" }}
            >
              Open report
            </a>
          {% endif %}
          {% if current_user %}
            <form method="post" action="/logout">
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <button class="ds-button ds-button--secondary ds-button--sm" type="submit">Logout</button>
            </form>
          {% else %}
            <a class="ds-button ds-button--primary ds-button--sm" href="/login">Get access</a>
          {% endif %}
          <label class="ds-toggle app-theme-switch" aria-label="Toggle theme">
            <i class="material-icons app-theme-icon" aria-hidden="true">brightness_6</i>
            <input type="checkbox" role="switch" data-theme-toggle aria-label="Toggle theme" />
            <span class="ds-toggle-track" aria-hidden="true"></span>
          </label>
        </div>
      </div>
    </header>
    <main id="main" class="ds-container ds-main">
      {% if flash %}
        {% set flash_level = flash.level|default('info') %}
        {% set flash_role = 'alert' if flash_level in ['red', 'error', 'warning', 'amber'] else 'status' %}
        <div
          class="ds-alert ds-alert--{{ flash_level }}"
          role="{{ flash_role }}"
          aria-live="{{ 'assertive' if flash_role == 'alert' else 'polite' }}"
        >
          {{ flash.message }}
        </div>
      {% endif %}
      {% if maintenance_mode %}
        <div class="ds-alert ds-alert--warning" role="status" aria-live="polite">
          {{ maintenance_message }}
        </div>
      {% endif %}
      {% block content %}{% endblock %}
    </main>
    <footer class="ds-footer">
      <div class="ds-container ds-footer-inner">
        <span class="ds-footer-brand miscite-wordmark">miscite</span>
        <span class="ds-footer-meta">Transparent citation checks for modern research teams.</span>
        <div class="ds-footer-links">
          {% if current_user %}
            <a href="/dashboard">Dashboard</a>
            <a href="/billing">Billing</a>
            {% if not hide_report_access %}
              <a href="/reports/access">Open report</a>
            {% endif %}
          {% else %}
            <a href="/#features">Features</a>
            <a href="/#trust">Trust</a>
            <a href="/login">Get access</a>
          {% endif %}
        </div>
      </div>
    </footer>
    <script nonce="{{ csp_nonce }}">
      document.addEventListener("DOMContentLoaded", function () {
        var toggle = document.querySelector("[data-theme-toggle]");
        var root = document.documentElement;
        var storageKey = "miscite-theme";

        var mql = window.matchMedia ? window.matchMedia("(prefers-color-scheme: dark)") : null;
        var preferredTheme = function () {
          return mql && mql.matches ? "dark" : "light";
        };

        var applyTheme = function (theme) {
          if (theme === "light" || theme === "dark") {
            root.setAttribute("data-theme", theme);
          } else {
            root.removeAttribute("data-theme");
          }
          if (toggle) {
            var active = root.getAttribute("data-theme") || preferredTheme();
            toggle.checked = active === "dark";
            toggle.setAttribute("aria-checked", active === "dark" ? "true" : "false");
          }
        };

        var stored = null;
        try {
          stored = localStorage.getItem(storageKey);
        } catch (err) {
          stored = null;
        }
        applyTheme(stored);

        if (mql && mql.addEventListener) {
          mql.addEventListener("change", function () {
            // Keep following system unless the user explicitly set a theme.
            if (!root.getAttribute("data-theme")) {
              applyTheme(null);
            }
          });
        }

        if (toggle) {
          toggle.addEventListener("change", function () {
            var next = toggle.checked ? "dark" : "light";
            try {
              localStorage.setItem(storageKey, next);
            } catch (err) {
              // ignore write errors
            }
            applyTheme(next);
          });
        }

        var copyButtons = document.querySelectorAll("[data-copy-target]");
        var fallbackCopy = function (text) {
          var el = document.createElement("textarea");
          el.value = text;
          el.setAttribute("readonly", "true");
          el.style.position = "absolute";
          el.style.left = "-9999px";
          document.body.appendChild(el);
          el.select();
          try {
            document.execCommand("copy");
          } catch (err) {
            // ignore copy errors
          }
          document.body.removeChild(el);
        };

        var copyText = function (text) {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            return navigator.clipboard.writeText(text);
          }
          return new Promise(function (resolve) {
            fallbackCopy(text);
            resolve();
          });
        };
        var emitCopyEvent = function (targetId, ok) {
          try {
            window.dispatchEvent(
              new CustomEvent("miscite:copy", {
                detail: {
                  targetId: targetId || "",
                  ok: !!ok,
                },
              })
            );
          } catch (err) {
            // ignore event errors
          }
        };

        copyButtons.forEach(function (button) {
          button.addEventListener("click", function () {
            var targetId = button.getAttribute("data-copy-target");
            if (!targetId) return;
            var target = document.getElementById(targetId);
            if (!target) return;

            var text = "";
            if (typeof target.value === "string") {
              text = target.value;
              try {
                target.focus();
                target.select();
              } catch (err) {
                // ignore focus errors
              }
            } else {
              text = target.textContent || "";
            }

            text = (text || "").trim();
            if (!text) return;

            copyText(text)
              .then(function () {
                var previous = button.textContent;
                button.textContent = "Copied";
                button.disabled = true;
                emitCopyEvent(targetId, true);
                window.setTimeout(function () {
                  button.textContent = previous;
                  button.disabled = false;
                }, 900);
              })
              .catch(function () {
                fallbackCopy(text);
                emitCopyEvent(targetId, false);
              });
          });
        });
      });
    </script>
  </body>
</html>
